{% extends "base.html" %}

{% block breadcrumbs %}
<nav class="mb-4 text-sm" aria-label="Breadcrumb">
    <ol class="flex items-center gap-2 text-gray-500 dark:text-gray-400 flex-wrap">
        <li><a href="{{ base_path|default('') }}/" class="hover:text-gray-700 dark:hover:text-gray-300">Dashboard</a></li>
        <li><span aria-hidden="true">/</span></li>
        <li><a href="{{ base_path|default('') }}/configuration" class="hover:text-gray-700 dark:hover:text-gray-300">Configuration</a></li>
        <li><span aria-hidden="true">/</span></li>
        <li id="config-breadcrumb-tab" class="text-gray-900 dark:text-white font-medium" aria-current="page">Core Settings</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="fade-in pb-24">
    <!-- Getting started -->
    <div class="mb-6 p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800">
        <p class="text-sm text-blue-800 dark:text-blue-200"><strong>Getting started:</strong> 1. Add counties (Counties tab) → 2. Configure NWS API if needed → 3. Set up Asterisk &amp; Audio (optional) → 4. Save configuration.</p>
    </div>

    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Configuration</h1>
        <p class="text-gray-600 dark:text-gray-400">Manage all aspects of SkywarnPlus-NG configuration</p>
    </div>

    <!-- Mobile: Jump to section dropdown -->
    <div class="md:hidden mb-4">
        <label for="config-section-select" class="sr-only">Jump to section</label>
        <select id="config-section-select" onchange="showTab(this.value)" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
            <option value="core">Core Settings</option>
            <option value="nws">NWS API</option>
            <option value="counties">Counties</option>
            <option value="asterisk">Asterisk</option>
            <option value="audio">Audio &amp; TTS</option>
            <option value="alerts">Alert Behavior</option>
            <option value="filtering">Filtering</option>
            <option value="scripts">Scripts</option>
            <option value="logging">Logging</option>
            <option value="database">Database</option>
            <option value="monitoring">Monitoring</option>
            <option value="notifications">Notifications</option>
            <option value="subscribers">Subscribers</option>
            <option value="templates">Templates</option>
        </select>
    </div>

    <!-- Two-level tabs (desktop): primary groups + secondary sections -->
    <div class="mb-6 hidden md:block">
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="-mb-px flex flex-wrap gap-x-1" role="tablist" aria-label="Configuration groups" id="config-primary-tabs">
                <button type="button" role="tab" data-group="general" onclick="showConfigGroup('general')" id="primary-general" class="config-primary-tab active py-2 px-3 rounded-t font-medium text-sm border-b-2 border-blue-500 text-blue-600">General</button>
                <button type="button" role="tab" data-group="asterisk" onclick="showConfigGroup('asterisk')" id="primary-asterisk" class="config-primary-tab py-2 px-3 rounded-t font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Asterisk &amp; Audio</button>
                <button type="button" role="tab" data-group="alerts" onclick="showConfigGroup('alerts')" id="primary-alerts" class="config-primary-tab py-2 px-3 rounded-t font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Alerts</button>
                <button type="button" role="tab" data-group="notifications" onclick="showConfigGroup('notifications')" id="primary-notifications" class="config-primary-tab py-2 px-3 rounded-t font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Notifications</button>
                <button type="button" role="tab" data-group="system" onclick="showConfigGroup('system')" id="primary-system" class="config-primary-tab py-2 px-3 rounded-t font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">System</button>
            </nav>
            <div id="config-secondary-row" class="flex flex-wrap gap-x-2 gap-y-1 pt-2 pb-1 border-b border-gray-200 dark:border-gray-700 -mb-px">
                <nav id="secondary-general" class="secondary-tabs flex flex-wrap gap-x-2" role="tablist" aria-label="General sections">
                    <button type="button" role="tab" onclick="showTab('core')" id="tab-core" class="tab-button active py-1.5 px-2 border-b-2 font-medium text-sm whitespace-nowrap border-blue-500 text-blue-600">Core</button>
                    <button type="button" role="tab" onclick="showTab('nws')" id="tab-nws" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">NWS API</button>
                    <button type="button" role="tab" onclick="showTab('counties')" id="tab-counties" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Counties</button>
                </nav>
                <nav id="secondary-asterisk" class="secondary-tabs hidden flex flex-wrap gap-x-2" role="tablist" aria-label="Asterisk &amp; Audio">
                    <button type="button" role="tab" onclick="showTab('asterisk')" id="tab-asterisk" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Asterisk</button>
                    <button type="button" role="tab" onclick="showTab('audio')" id="tab-audio" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Audio &amp; TTS</button>
                </nav>
                <nav id="secondary-alerts" class="secondary-tabs hidden flex flex-wrap gap-x-2" role="tablist" aria-label="Alerts">
                    <button type="button" role="tab" onclick="showTab('alerts')" id="tab-alerts" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Alert Behavior</button>
                    <button type="button" role="tab" onclick="showTab('filtering')" id="tab-filtering" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Filtering</button>
                    <button type="button" role="tab" onclick="showTab('scripts')" id="tab-scripts" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Scripts</button>
                </nav>
                <nav id="secondary-notifications" class="secondary-tabs hidden flex flex-wrap gap-x-2" role="tablist" aria-label="Notifications">
                    <button type="button" role="tab" onclick="showTab('notifications')" id="tab-notifications" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Notifications</button>
                    <button type="button" role="tab" onclick="showTab('subscribers')" id="tab-subscribers" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Subscribers</button>
                    <button type="button" role="tab" onclick="showTab('templates')" id="tab-templates" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Templates</button>
                </nav>
                <nav id="secondary-system" class="secondary-tabs hidden flex flex-wrap gap-x-2" role="tablist" aria-label="System">
                    <button type="button" role="tab" onclick="showTab('logging')" id="tab-logging" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Logging</button>
                    <button type="button" role="tab" onclick="showTab('database')" id="tab-database" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Database</button>
                    <button type="button" role="tab" onclick="showTab('monitoring')" id="tab-monitoring" class="tab-button py-1.5 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Monitoring</button>
                </nav>
            </div>
        </div>
    </div>

    <!-- Configuration Form -->
    <form id="config-form" class="space-y-8" onsubmit="event.preventDefault(); saveConfig(); return false;">
        <!-- Core Settings Tab -->
        <div id="tab-content-core" class="tab-content">
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Core Application Settings</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Application Enabled
                        </label>
                        <div class="flex items-center">
                            <input type="checkbox" id="enabled" name="enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="enabled" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                                Enable SkywarnPlus-NG
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label for="poll_interval" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Poll Interval (seconds)
                        </label>
                        <input type="number" id="poll_interval" name="poll_interval" min="10" max="3600" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div>
                        <label for="data_dir" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Data Directory
                        </label>
                        <input type="text" id="data_dir" name="data_dir" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div>
                        <label for="config_file" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Configuration File
                        </label>
                        <input type="text" id="config_file" name="config_file" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                </div>
            </div>
        </div>

        <!-- NWS API Tab -->
        <div id="tab-content-nws" class="tab-content hidden">
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">NWS API Configuration</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="nws_base_url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Base URL
                        </label>
                        <input type="url" id="nws_base_url" name="nws.base_url" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div>
                        <label for="nws_timeout" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Timeout (seconds)
                        </label>
                        <input type="number" id="nws_timeout" name="nws.timeout" min="5" max="300" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="nws_user_agent" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            User Agent
                        </label>
                        <input type="text" id="nws_user_agent" name="nws.user_agent" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                </div>
            </div>
        </div>

        <!-- Counties Tab -->
        <div id="tab-content-counties" class="tab-content hidden">
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">County Configuration</h3>
                
                <div id="counties-container">
                    <!-- Counties will be dynamically added here -->
                </div>
                
                <button type="button" onclick="showCountySearch()" class="mt-4 btn-primary">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                    Search & Add County
                </button>
                <button type="button" onclick="addCounty()" class="mt-4 ml-2 btn-secondary">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                    </svg>
                    Manually Add County
                </button>
            </div>
        </div>

        <!-- Asterisk Tab -->
        <div id="tab-content-asterisk" class="tab-content hidden">
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Asterisk Configuration</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="asterisk_enabled" name="asterisk.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="asterisk_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Enable Asterisk Integration
                        </label>
                    </div>
                    
                    <div>
                        <label for="asterisk_audio_delay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Audio Delay (milliseconds)
                        </label>
                        <input type="number" id="asterisk_audio_delay" name="asterisk.audio_delay" min="0" max="5000" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div>
                        <div class="flex items-center gap-1.5 mb-2">
                            <label for="asterisk_playback_mode" class="text-sm font-medium text-gray-700 dark:text-gray-300">Playback Mode</label>
                            <span class="info-tooltip cursor-help" title="Local: playback only on this node. Global: broadcast to all linked Asterisk nodes." aria-label="Playback mode help">ℹ️</span>
                        </div>
                        <select id="asterisk_playback_mode" name="asterisk.playback_mode" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                            <option value="local">Local (default)</option>
                            <option value="global">Global</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Local: Playback only on the local node. Global: Broadcast to all linked nodes.
                        </p>
                    </div>
                    
                    <div>
                        <label for="asterisk_ami_host" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            AMI Host
                        </label>
                        <input type="text" id="asterisk_ami_host" name="asterisk.ami_host" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                               placeholder="127.0.0.1">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Asterisk AMI server hostname or IP address
                        </p>
                    </div>
                    
                    <div>
                        <label for="asterisk_ami_port" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            AMI Port
                        </label>
                        <input type="number" id="asterisk_ami_port" name="asterisk.ami_port" min="1" max="65535" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                               placeholder="5038">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Asterisk AMI server port (default: 5038)
                        </p>
                    </div>
                    
                    <div>
                        <label for="asterisk_ami_username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            AMI Username
                        </label>
                        <input type="text" id="asterisk_ami_username" name="asterisk.ami_username" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                               placeholder="AMI username">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Asterisk AMI username (configured in manager.conf)
                        </p>
                    </div>
                    
                    <div>
                        <label for="asterisk_ami_secret" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            AMI Secret/Password
                        </label>
                        <input type="password" id="asterisk_ami_secret" name="asterisk.ami_secret" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                               placeholder="AMI secret/password">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Asterisk AMI secret/password (configured in manager.conf)
                        </p>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Target Nodes
                        </label>
                        <div id="nodes-container">
                            <!-- Nodes will be dynamically added here -->
                        </div>
                        <button type="button" onclick="addNode()" class="mt-2 btn-secondary text-sm">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            Add Node
                        </button>
                    </div>
                </div>
            </div>

            <!-- Courtesy Tones Section -->
            <div class="card mt-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Courtesy Tones</h3>
                
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800 dark:text-blue-200">
                        <strong>Note:</strong> Courtesy tones are audio files that play after transmissions. When enabled, the system will automatically switch between "normal" and "wx" (weather alert) mode tones based on active weather alerts.
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="ct_enabled" name="asterisk.courtesy_tones.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="ct_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Enable Automatic Courtesy Tone Switching
                        </label>
                    </div>

                    <div>
                        <label for="ct_tone_dir" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Tone Directory
                        </label>
                        <input type="text" id="ct_tone_dir" name="asterisk.courtesy_tones.tone_dir" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                               placeholder="SOUNDS/TONES">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Directory where tone files are stored (relative to installation or absolute path)
                        </p>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            CT Alerts (Triggers WX Mode)
                        </label>
                        <div id="ct-alerts-container">
                            <!-- CT alerts will be dynamically added here -->
                        </div>
                        <button type="button" onclick="addCTAlert()" class="mt-2 btn-secondary text-sm">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            Add Alert Type
                        </button>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Alert events that trigger WX mode. Supports glob patterns (e.g., "*Warning", "Tornado*").
                        </p>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Tone Mappings
                        </label>
                        <div id="ct-tones-container">
                            <!-- CT tone mappings will be dynamically added here -->
                        </div>
                        <button type="button" onclick="addCTTone()" class="mt-2 btn-secondary text-sm">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            Add Tone Mapping
                        </button>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Configure which tone files to use for each CT key in Normal and WX modes. Example: ct1 uses "Boop.ulaw" in Normal mode and "Stardust.ulaw" in WX mode.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ID Change Section -->
            <div class="card mt-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">ID Change</h3>
                
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800 dark:text-blue-200">
                        <strong>Note:</strong> ID changes allow dynamically switching the node identifier audio file between "normal" and "wx" (weather alert) mode based on active weather alerts. Requires initial setup in rpt.conf and manual creation of audio files.
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="id_change_enabled" name="asterisk.id_change.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="id_change_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Enable Automatic ID Changing
                        </label>
                    </div>

                    <div>
                        <label for="id_change_id_dir" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            ID Directory
                        </label>
                        <input type="text" id="id_change_id_dir" name="asterisk.id_change.id_dir" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                               placeholder="SOUNDS/ID">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Directory where ID files are stored (relative to installation or absolute path)
                        </p>
                    </div>

                    <div>
                        <label for="id_change_normal_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Normal Mode ID File
                        </label>
                        <input type="text" id="id_change_normal_id" name="asterisk.id_change.normal_id" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                               placeholder="NORMALID.ulaw">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Audio file for normal mode ID
                        </p>
                    </div>

                    <div>
                        <label for="id_change_wx_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            WX Mode ID File
                        </label>
                        <input type="text" id="id_change_wx_id" name="asterisk.id_change.wx_id" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                               placeholder="WXID.ulaw">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Audio file for WX mode ID
                        </p>
                    </div>

                    <div>
                        <label for="id_change_rpt_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            RPT ID File (Target)
                        </label>
                        <input type="text" id="id_change_rpt_id" name="asterisk.id_change.rpt_id" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                               placeholder="RPTID.ulaw">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Audio file that Asterisk uses as ID (this file gets replaced)
                        </p>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            ID Alerts (Triggers WX Mode)
                        </label>
                        <div id="id-alerts-container">
                            <!-- ID alerts will be dynamically added here -->
                        </div>
                        <button type="button" onclick="addIDAlert()" class="mt-2 btn-secondary text-sm">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            Add Alert Type
                        </button>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Alert events that trigger WX mode. Supports glob patterns (e.g., "*Warning", "Tornado*").
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audio & TTS Tab -->
        <div id="tab-content-audio" class="tab-content hidden">
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Audio & TTS Configuration</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="audio_sounds_path" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Sounds Directory
                        </label>
                        <input type="text" id="audio_sounds_path" name="audio.sounds_path" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div>
                        <label for="audio_alert_sound" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Alert Sound File
                        </label>
                        <input type="text" id="audio_alert_sound" name="audio.alert_sound" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div>
                        <label for="audio_all_clear_sound" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            All Clear Sound File
                        </label>
                        <input type="text" id="audio_all_clear_sound" name="audio.all_clear_sound" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div>
                        <label for="audio_separator_sound" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Separator Sound File
                        </label>
                        <input type="text" id="audio_separator_sound" name="audio.separator_sound" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div>
                        <label for="audio_temp_dir" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Temporary Directory
                        </label>
                        <input type="text" id="audio_temp_dir" name="audio.temp_dir" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-4">TTS Configuration</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="tts_engine" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                TTS Engine
                            </label>
                            <select id="tts_engine" name="audio.tts.engine" 
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                                    onchange="updateTTSEngineFields()">
                                <option value="gtts">Google Text-to-Speech (gTTS)</option>
                                <option value="piper">Piper TTS (Local)</option>
                            </select>
                        </div>
                        
                        <!-- gTTS-specific fields -->
                        <div id="tts_gtts_language" class="tts-gtts-field">
                            <label for="tts_language" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Language
                            </label>
                            <input type="text" id="tts_language" name="audio.tts.language" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                        </div>
                        
                        <div id="tts_gtts_tld" class="tts-gtts-field">
                            <label for="tts_tld" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Top-Level Domain
                            </label>
                            <input type="text" id="tts_tld" name="audio.tts.tld" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                        </div>
                        
                        <div id="tts_gtts_slow" class="tts-gtts-field flex items-center">
                            <input type="checkbox" id="tts_slow" name="audio.tts.slow" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="tts_slow" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Slow Speech
                            </label>
                        </div>
                        
                        <!-- Piper-specific fields -->
                        <div id="tts_piper_model_path" class="tts-piper-field">
                            <label for="tts_model_path" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Model Path (.onnx file)
                            </label>
                            <input type="text" id="tts_model_path" name="audio.tts.model_path" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                                   placeholder="/path/to/model.onnx">
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                Path to Piper TTS model file (.onnx). The corresponding .onnx.json file should be in the same directory.
                            </p>
                        </div>
                        
                        <div id="tts_piper_speed" class="tts-piper-field">
                            <label for="tts_speed" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Speech Speed
                            </label>
                            <input type="number" id="tts_speed" name="audio.tts.speed" min="0.5" max="2.0" step="0.1"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                                   placeholder="1.0">
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                1.0 = normal speed, &gt;1.0 = faster, &lt;1.0 = slower
                            </p>
                        </div>
                        
                        <div>
                            <label for="tts_output_format" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Output Format
                            </label>
                            <select id="tts_output_format" name="audio.tts.output_format" 
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                                <option value="ulaw" selected>μ-law (ulaw) - Recommended for Asterisk</option>
                                <option value="wav">WAV</option>
                                <option value="mp3">MP3</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                μ-law format is recommended for Asterisk/app_rpt compatibility and requires 8kHz sample rate.
                            </p>
                        </div>
                        
                        <div>
                            <label for="tts_sample_rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Sample Rate (Hz)
                            </label>
                            <input type="number" id="tts_sample_rate" name="audio.tts.sample_rate" min="8000" max="48000" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                                   placeholder="8000">
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                Required: 8000 Hz for μ-law format. Default: 8000 Hz.
                            </p>
                        </div>
                        
                        <div>
                            <label for="tts_bit_rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Bit Rate (kbps)
                            </label>
                            <input type="number" id="tts_bit_rate" name="audio.tts.bit_rate" min="64" max="320" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Behavior Tab -->
        <div id="tab-content-alerts" class="tab-content hidden">
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Alert Behavior Configuration</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="alerts_say_alert" name="alerts.say_alert" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="alerts_say_alert" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Enable Voice Announcements
                        </label>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="alerts_say_all_clear" name="alerts.say_all_clear" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="alerts_say_all_clear" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Enable All-Clear Announcements
                        </label>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="alerts_tail_message" name="alerts.tail_message" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="alerts_tail_message" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Enable Tail Messages
                        </label>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Tail Message Configuration
                        </label>
                        <div class="space-y-4">
                            <div>
                                <label for="alerts_tail_message_path" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">
                                    Tail Message File Path (leave empty for default)
                                </label>
                                <input type="text" id="alerts_tail_message_path" name="alerts.tail_message_path" 
                                       placeholder="/var/lib/skywarnplus-ng/data/wx-tail.wav"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    Default: /var/lib/skywarnplus-ng/data/wx-tail.wav
                                </p>
                            </div>
                            <div>
                                <label for="alerts_tail_message_suffix" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">
                                    Tail Message Suffix Audio File (optional)
                                </label>
                                <input type="text" id="alerts_tail_message_suffix" name="alerts.tail_message_suffix" 
                                       placeholder="suffix.wav"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    Audio file from SOUNDS directory to append to tail message
                                </p>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="alerts_tail_message_counties" name="alerts.tail_message_counties" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="alerts_tail_message_counties" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Include County Names in Tail Message
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="alerts_with_county_names" name="alerts.with_county_names" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="alerts_with_county_names" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Include County Names in Announcements
                        </label>
                    </div>
                    
                    <div>
                        <div class="flex items-center gap-1.5 mb-2">
                            <label for="alerts_time_type" class="text-sm font-medium text-gray-700 dark:text-gray-300">Time Type</label>
                            <span class="info-tooltip" title="Onset: when conditions begin. Effective: when alert was issued (recommended for watches)." aria-label="Time type help">ℹ️</span>
                        </div>
                        <select id="alerts_time_type" name="alerts.time_type" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                            <option value="onset">Onset Time</option>
                            <option value="effective">Effective Time</option>
                        </select>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            <strong>Onset Time:</strong> Uses when weather conditions actually begin. May filter out watches issued in advance.<br>
                            <strong>Effective Time:</strong> Uses when the alert was issued. Recommended for watches.
                        </p>
                    </div>
                    
                    <!-- Alert Suffixes Section -->
                    <div class="md:col-span-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">
                            Alert Suffixes
                        </label>
                        <div class="space-y-4">
                            <div>
                                <label for="alerts_say_alert_suffix" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">
                                    Alert Announcement Suffix Audio File (optional)
                                </label>
                                <input type="text" id="alerts_say_alert_suffix" name="alerts.say_alert_suffix" 
                                       placeholder="alert_suffix.wav"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    Audio file from SOUNDS directory to append to alert announcements
                                </p>
                            </div>
                            <div>
                                <label for="alerts_say_all_clear_suffix" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">
                                    All-Clear Announcement Suffix Audio File (optional)
                                </label>
                                <input type="text" id="alerts_say_all_clear_suffix" name="alerts.say_all_clear_suffix" 
                                       placeholder="allclear_suffix.wav"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    Audio file from SOUNDS directory to append to all-clear announcements
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- County Audio Features Section -->
                    <div class="md:col-span-2 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">
                            County Audio Features
                        </label>
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="alerts_say_alerts_changed" name="alerts.say_alerts_changed" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="alerts_say_alerts_changed" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Announce Alerts When County List Changes
                                </label>
                            </div>
                            <p class="text-xs text-gray-600 dark:text-gray-400 ml-6">
                                When enabled, alerts will be re-announced if their county list changes
                            </p>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="alerts_say_alert_all" name="alerts.say_alert_all" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="alerts_say_alert_all" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Say All Alerts When One Changes
                                </label>
                            </div>
                            <p class="text-xs text-gray-600 dark:text-gray-400 ml-6">
                                When enabled, all active alerts will be announced when any alert's county list changes (requires "Announce Alerts When County List Changes")
                            </p>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="alerts_with_multiples" name="alerts.with_multiples" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="alerts_with_multiples" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Tag Alerts With "With Multiples"
                                </label>
                            </div>
                            <p class="text-xs text-gray-600 dark:text-gray-400 ml-6">
                                When enabled, alerts with multiple unique instances will be tagged with ", with multiples" in announcements
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtering Tab -->
        <div id="tab-content-filtering" class="tab-content hidden">
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Alert Filtering Configuration</h3>
                
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label for="filtering_max_alerts" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Maximum Alerts to Process
                        </label>
                        <input type="number" id="filtering_max_alerts" name="filtering.max_alerts" min="1" max="999" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Globally Blocked Events (glob patterns)
                        </label>
                        <div id="blocked-events-container">
                            <!-- Blocked events will be dynamically added here -->
                        </div>
                        <button type="button" onclick="addBlockedEvent()" class="mt-2 btn-secondary text-sm">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            Add Pattern
                        </button>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Events Blocked from Voice Announcement (glob patterns)
                        </label>
                        <div id="say-alert-blocked-container">
                            <!-- Say alert blocked patterns will be dynamically added here -->
                        </div>
                        <button type="button" onclick="addSayAlertBlocked()" class="mt-2 btn-secondary text-sm">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            Add Pattern
                        </button>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Events Blocked from Tail Message (glob patterns)
                        </label>
                        <div id="tail-message-blocked-container">
                            <!-- Tail message blocked patterns will be dynamically added here -->
                        </div>
                        <button type="button" onclick="addTailMessageBlocked()" class="mt-2 btn-secondary text-sm">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            Add Pattern
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scripts Tab -->
        <div id="tab-content-scripts" class="tab-content hidden">
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Script Configuration</h3>
                
                <div class="grid grid-cols-1 gap-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="scripts_enabled" name="scripts.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="scripts_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Enable Script Execution
                        </label>
                    </div>
                    
                    <div>
                        <label for="scripts_default_timeout" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Default Script Timeout (seconds)
                        </label>
                        <input type="number" id="scripts_default_timeout" name="scripts.default_timeout" min="5" max="300" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div>
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-4">Alert Scripts</h4>
                        <div id="alert-scripts-container">
                            <!-- Alert scripts will be dynamically added here -->
                        </div>
                        <button type="button" onclick="addAlertScript()" class="mt-2 btn-secondary">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            Add Alert Script
                        </button>
                    </div>
                    
                    <div>
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-4">All-Clear Script</h4>
                        <div id="all-clear-script-container">
                            <!-- All-clear script will be dynamically added here -->
                        </div>
                        <button type="button" onclick="addAllClearScript()" class="mt-2 btn-secondary">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            Add All-Clear Script
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logging Tab -->
        <div id="tab-content-logging" class="tab-content hidden">
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Logging Configuration</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="logging_level" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Log Level
                        </label>
                        <select id="logging_level" name="logging.level" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="logging_format" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Log Format
                        </label>
                        <select id="logging_format" name="logging.format" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                            <option value="json">JSON</option>
                            <option value="text">Text</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="logging_file" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Log File Path
                        </label>
                        <input type="text" id="logging_file" name="logging.file" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Leave empty to disable file logging</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Tab -->
        <div id="tab-content-database" class="tab-content hidden">
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Database Configuration</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="database_enabled" name="database.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="database_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Enable Database Storage
                        </label>
                    </div>
                    
                    <div>
                        <label for="database_url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Database URL
                        </label>
                        <input type="text" id="database_url" name="database.url" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Leave empty to use SQLite</p>
                    </div>
                    
                    <div>
                        <label for="database_cleanup_interval" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Cleanup Interval (hours)
                        </label>
                        <input type="number" id="database_cleanup_interval" name="database.cleanup_interval_hours" min="1" max="168" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div>
                        <label for="database_retention_days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Data Retention (days)
                        </label>
                        <input type="number" id="database_retention_days" name="database.retention_days" min="1" max="365" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="database_backup_enabled" name="database.backup_enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="database_backup_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Enable Automatic Backups
                        </label>
                    </div>
                    
                    <div>
                        <label for="database_backup_interval" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Backup Interval (hours)
                        </label>
                        <input type="number" id="database_backup_interval" name="database.backup_interval_hours" min="1" max="168" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                </div>
            </div>

            <!-- Database Operations Section -->
            <div class="card mt-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Database Operations</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button onclick="cleanupDatabase()" class="btn-secondary w-full">
                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"></path>
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        Cleanup Old Data
                    </button>
                    
                    <button onclick="backupDatabase()" class="btn-secondary w-full">
                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"></path>
                        </svg>
                        Backup Database
                    </button>
                    
                    <button onclick="optimizeDatabase()" class="btn-secondary w-full">
                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                        </svg>
                        Optimize Database
                    </button>
                </div>

                <div id="database-stats" class="mt-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Database Statistics</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Total Alerts:</span>
                            <span id="db-total-alerts" class="ml-2 font-semibold text-gray-900 dark:text-white">-</span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Database Size:</span>
                            <span id="db-size" class="ml-2 font-semibold text-gray-900 dark:text-white">-</span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Metrics:</span>
                            <span id="db-metrics" class="ml-2 font-semibold text-gray-900 dark:text-white">-</span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Health Checks:</span>
                            <span id="db-health-checks" class="ml-2 font-semibold text-gray-900 dark:text-white">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring Tab -->
        <div id="tab-content-monitoring" class="tab-content hidden">
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Monitoring Configuration</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="monitoring_enabled" name="monitoring.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="monitoring_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Enable Monitoring
                        </label>
                    </div>
                    
                    <div>
                        <label for="monitoring_health_check_interval" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Health Check Interval (seconds)
                        </label>
                        <input type="number" id="monitoring_health_check_interval" name="monitoring.health_check_interval" min="10" max="3600" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    </div>
                    
                    <div class="md:col-span-2">
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-4">HTTP Server</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="flex items-center">
                                <input type="checkbox" id="monitoring_http_enabled" name="monitoring.http_server.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="monitoring_http_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Enable HTTP Server
                                </label>
                            </div>
                            
                            <div>
                                <label for="monitoring_http_host" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Host
                                </label>
                                <input type="text" id="monitoring_http_host" name="monitoring.http_server.host" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                            </div>
                            
                            <div>
                                <label for="monitoring_http_port" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Port
                                </label>
                                <input type="number" id="monitoring_http_port" name="monitoring.http_server.port" min="1" max="65535" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-4">Metrics</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="flex items-center">
                                <input type="checkbox" id="monitoring_metrics_enabled" name="monitoring.metrics.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="monitoring_metrics_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Enable Metrics Collection
                                </label>
                            </div>
                            
                            <div>
                                <label for="monitoring_metrics_retention" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Metrics Retention (days)
                                </label>
                                <input type="number" id="monitoring_metrics_retention" name="monitoring.metrics.retention_days" min="1" max="365" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-4">Authentication</h4>
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.725-1.36 3.49 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <p class="text-sm text-yellow-800 dark:text-yellow-200">
                                    <strong>Security Note:</strong> Authentication only protects the configuration page. All monitoring features remain publicly accessible.
                                </p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="flex items-center">
                                <input type="checkbox" id="monitoring_auth_enabled" name="monitoring.http_server.auth.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="monitoring_auth_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Enable Authentication
                                </label>
                            </div>
                            
                            <div>
                                <label for="monitoring_auth_session_timeout" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Session Timeout (hours)
                                </label>
                                <input type="number" id="monitoring_auth_session_timeout" name="monitoring.http_server.auth.session_timeout_hours" min="1" max="168" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                            </div>
                            
                            <div>
                                <label for="monitoring_auth_username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Username
                                </label>
                                <input type="text" id="monitoring_auth_username" name="monitoring.http_server.auth.username" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                                       placeholder="admin">
                            </div>
                            
                            <div>
                                <label for="monitoring_auth_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Password
                                </label>
                                <div class="relative">
                                    <input type="password" id="monitoring_auth_password" name="monitoring.http_server.auth.password" 
                                           class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                                           placeholder="Enter new password">
                                    <button type="button" onclick="togglePasswordVisibility('monitoring_auth_password')" 
                                            class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                        <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                    </button>
                                </div>
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    Leave blank to keep current password
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-4">PushOver Notifications</h4>
                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                                </svg>
                                <p class="text-sm text-blue-800 dark:text-blue-200">
                                    <strong>PushOver:</strong> Mobile push notifications for weather alerts. Priority is automatically adjusted based on alert severity.
                                </p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="flex items-center">
                                <input type="checkbox" id="pushover_enabled" name="pushover.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="pushover_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Enable PushOver Notifications
                                </label>
                            </div>
                            
                            <div>
                                <label for="pushover_priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Default Priority (-2 to 2)
                                </label>
                                <input type="number" id="pushover_priority" name="pushover.priority" min="-2" max="2" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                                       placeholder="0 (normal)">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    -2 (silent) to 2 (emergency). Alert severity overrides this.
                                </p>
                            </div>
                            
                            <div>
                                <label for="pushover_api_token" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    API Token
                                </label>
                                <input type="password" id="pushover_api_token" name="pushover.api_token" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                                       placeholder="Your PushOver application token">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    Create at <a href="https://pushover.net/apps/build" target="_blank" class="text-blue-600 hover:text-blue-800">pushover.net/apps/build</a>
                                </p>
                            </div>
                            
                            <div>
                                <label for="pushover_user_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    User Key
                                </label>
                                <input type="password" id="pushover_user_key" name="pushover.user_key" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                                       placeholder="Your PushOver user key">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    Find at <a href="https://pushover.net/" target="_blank" class="text-blue-600 hover:text-blue-800">pushover.net</a>
                                </p>
                            </div>
                            
                            <div>
                                <label for="pushover_sound" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Default Sound
                                </label>
                                <input type="text" id="pushover_sound" name="pushover.sound" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                                       placeholder="Leave empty for device default">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    Optional: pushover, siren, magic, etc. (see <a href="https://pushover.net/api#sounds" target="_blank" class="text-blue-600 hover:text-blue-800">available sounds</a>)
                                </p>
                            </div>
                            
                            <div>
                                <label for="pushover_timeout" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Timeout (seconds)
                                </label>
                                <input type="number" id="pushover_timeout" name="pushover.timeout_seconds" min="5" max="120" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                            </div>
                        </div>
                    </div>
                    
                    <!-- DEV Section -->
                    <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-8">
                        <div class="md:col-span-2">
                            <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-4">Development & Testing</h4>
                            <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-4 mb-4">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-orange-600 dark:text-orange-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.725-1.36 3.49 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    <p class="text-sm text-orange-800 dark:text-orange-200">
                                        <strong>Warning:</strong> Test alert injection bypasses the NWS API for development/testing only. Keep disabled in production.
                                    </p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 gap-6">
                                <div class="flex items-center">
                                    <input type="checkbox" id="dev_inject_enabled" name="dev.inject_enabled" class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                                    <label for="dev_inject_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Enable Test Alert Injection
                                    </label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="dev_cleanslate" name="dev.cleanslate" class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                                    <label for="dev_cleanslate" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Cleanslate Mode (Clear state on startup)
                                    </label>
                                </div>
                                
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                                    <p class="text-sm text-gray-700 dark:text-gray-300">
                                        <strong>Test Alert Behavior:</strong> When enabled, the system will automatically generate a fake "Tornado Warning" alert for all configured counties. This allows you to test the alert system without relying on actual NWS data.
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                        The test alert includes fake location information and will expire 1 hour after creation. Configure your counties in the Counties tab for the test alert to target them.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Tab -->
        <div id="tab-content-notifications" class="tab-content hidden">
            <div class="space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Email Notifications</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Email Provider
                            </label>
                            <select name="notifications.email.provider" class="form-input">
                                <option value="gmail">Gmail</option>
                                <option value="outlook">Outlook</option>
                                <option value="yahoo">Yahoo</option>
                                <option value="icloud">iCloud</option>
                                <option value="custom">Custom SMTP</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                SMTP Server
                            </label>
                            <input type="text" name="notifications.email.smtp_server" class="form-input" placeholder="smtp.gmail.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                SMTP Port
                            </label>
                            <input type="number" name="notifications.email.smtp_port" class="form-input" placeholder="587">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Username/Email
                            </label>
                            <input type="email" name="notifications.email.username" class="form-input" placeholder="your-email@gmail.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Password/App Password
                            </label>
                            <input type="password" name="notifications.email.password" class="form-input" placeholder="Your password or app password">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                From Name
                            </label>
                            <input type="text" name="notifications.email.from_name" class="form-input" placeholder="SkywarnPlus-NG">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="notifications.email.use_tls" class="form-checkbox">
                            <label class="ml-2 text-sm text-gray-700 dark:text-gray-300">Use TLS</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="notifications.email.use_ssl" class="form-checkbox">
                            <label class="ml-2 text-sm text-gray-700 dark:text-gray-300">Use SSL</label>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="button" onclick="testEmailConnection()" class="btn-secondary">
                            Test Email Connection
                        </button>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Webhook Notifications</h3>
                    <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md">
                        <p class="text-sm text-blue-800 dark:text-blue-200">
                            <strong>Note:</strong> Discord webhooks should be configured through the <strong>Subscribers</strong> section below to enable per-county filtering and prevent duplicate notifications.
                        </p>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Slack Webhook URL
                            </label>
                            <input type="url" name="notifications.webhook.slack_url" class="form-input" placeholder="https://hooks.slack.com/services/...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Microsoft Teams Webhook URL
                            </label>
                            <input type="url" name="notifications.webhook.teams_url" class="form-input" placeholder="https://outlook.office.com/webhook/...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Generic Webhook URL
                            </label>
                            <input type="url" name="notifications.webhook.generic_url" class="form-input" placeholder="https://your-webhook-endpoint.com/...">
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Push Notifications</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Firebase FCM Server Key
                            </label>
                            <input type="password" name="notifications.push.fcm_server_key" class="form-input" placeholder="Your FCM server key">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Firebase Project ID
                            </label>
                            <input type="text" name="notifications.push.fcm_project_id" class="form-input" placeholder="your-project-id">
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Delivery Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Max Concurrent Deliveries
                            </label>
                            <input type="number" name="notifications.delivery.max_concurrent" class="form-input" value="10">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Delivery Timeout (seconds)
                            </label>
                            <input type="number" name="notifications.delivery.timeout_seconds" class="form-input" value="30">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Max Retries
                            </label>
                            <input type="number" name="notifications.delivery.max_retries" class="form-input" value="3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Retry Delay (seconds)
                            </label>
                            <input type="number" name="notifications.delivery.retry_delay" class="form-input" value="5">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscribers Tab -->
        <div id="tab-content-subscribers" class="tab-content hidden">
            <div class="space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Subscribers</h3>
                        <button type="button" onclick="addSubscriber()" class="btn-primary">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            Add Subscriber
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="table-cards-mobile min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Methods</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Counties</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="subscribers-table" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Subscribers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <!-- Templates Tab -->
        <div id="tab-content-templates" class="tab-content hidden">
            <div class="space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Notification Templates</h3>
                        <button type="button" onclick="addTemplate()" class="btn-primary">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            Add Template
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="templates-grid">
                        <!-- Templates will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Subscriber Modal -->
    <div id="subscriber-modal" class="fixed inset-0 bg-gray-700 bg-opacity-60 hidden z-50 items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h3 id="subscriber-modal-title" class="text-lg font-semibold text-gray-900 dark:text-white">
                    Add Subscriber
                </h3>
                <button type="button" onclick="closeSubscriberModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="subscriber-form" class="px-6 py-6 space-y-6" onsubmit="saveSubscriber(event)">
                <input type="hidden" id="subscriber_id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Name</label>
                        <input type="text" id="subscriber_name" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">Email</label>
                        <input type="email" id="subscriber_email" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">Status</label>
                        <select id="subscriber_status" class="form-input">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspended">Suspended</option>
                            <option value="unsubscribed">Unsubscribed</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Phone (optional)</label>
                        <input type="tel" id="subscriber_phone" class="form-input" placeholder="+1-555-123-4567">
                    </div>
                    <div>
                        <label class="form-label">Webhook URL</label>
                        <input type="url" id="subscriber_webhook" class="form-input" placeholder="https://example.com/webhook">
                    </div>
                    <div>
                        <label class="form-label">Push Tokens</label>
                        <textarea id="subscriber_push_tokens" class="form-input" rows="2" placeholder="One token per line"></textarea>
                    </div>
                </div>
                
                <div>
                    <label class="form-label">Notification Methods</label>
                    <div class="flex flex-wrap gap-4 text-sm text-gray-700 dark:text-gray-300">
                        <label class="inline-flex items-center gap-2">
                            <input type="checkbox" value="email" class="form-checkbox subscriber-method">
                            Email
                        </label>
                        <label class="inline-flex items-center gap-2">
                            <input type="checkbox" value="webhook" class="form-checkbox subscriber-method">
                            Webhook
                        </label>
                        <label class="inline-flex items-center gap-2">
                            <input type="checkbox" value="push" class="form-checkbox subscriber-method">
                            Push
                        </label>
                        <label class="inline-flex items-center gap-2">
                            <input type="checkbox" value="sms" class="form-checkbox subscriber-method">
                            SMS (beta)
                        </label>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Counties (comma separated)</label>
                        <textarea id="subscriber_counties" class="form-input" rows="2" placeholder="TXC039, TXC201"></textarea>
                    </div>
                    <div>
                        <label class="form-label">States (comma separated)</label>
                        <textarea id="subscriber_states" class="form-input" rows="2" placeholder="TX, OK"></textarea>
                    </div>
                    <div>
                        <label class="form-label">Custom Areas (comma separated)</label>
                        <textarea id="subscriber_custom_areas" class="form-input" rows="2" placeholder="Houston, Galveston"></textarea>
                    </div>
                    <div>
                        <label class="form-label">Enabled Events (comma separated)</label>
                        <textarea id="subscriber_enabled_events" class="form-input" rows="2" placeholder="Tornado Warning, Severe Thunderstorm Warning"></textarea>
                    </div>
                    <div>
                        <label class="form-label">Blocked Events (comma separated)</label>
                        <textarea id="subscriber_blocked_events" class="form-input" rows="2" placeholder="*Advisory"></textarea>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="form-label mb-2">Severities</p>
                        <div class="space-y-1 text-sm text-gray-700 dark:text-gray-300">
                            <label class="flex items-center gap-2"><input type="checkbox" value="Minor" class="form-checkbox subscriber-severity"> Minor</label>
                            <label class="flex items-center gap-2"><input type="checkbox" value="Moderate" class="form-checkbox subscriber-severity"> Moderate</label>
                            <label class="flex items-center gap-2"><input type="checkbox" value="Severe" class="form-checkbox subscriber-severity"> Severe</label>
                            <label class="flex items-center gap-2"><input type="checkbox" value="Extreme" class="form-checkbox subscriber-severity"> Extreme</label>
                        </div>
                    </div>
                    <div>
                        <p class="form-label mb-2">Urgencies</p>
                        <div class="space-y-1 text-sm text-gray-700 dark:text-gray-300">
                            <label class="flex items-center gap-2"><input type="checkbox" value="Future" class="form-checkbox subscriber-urgency"> Future</label>
                            <label class="flex items-center gap-2"><input type="checkbox" value="Expected" class="form-checkbox subscriber-urgency"> Expected</label>
                            <label class="flex items-center gap-2"><input type="checkbox" value="Immediate" class="form-checkbox subscriber-urgency"> Immediate</label>
                        </div>
                    </div>
                    <div>
                        <p class="form-label mb-2">Certainties</p>
                        <div class="space-y-1 text-sm text-gray-700 dark:text-gray-300">
                            <label class="flex items-center gap-2"><input type="checkbox" value="Possible" class="form-checkbox subscriber-certainty"> Possible</label>
                            <label class="flex items-center gap-2"><input type="checkbox" value="Likely" class="form-checkbox subscriber-certainty"> Likely</label>
                            <label class="flex items-center gap-2"><input type="checkbox" value="Observed" class="form-checkbox subscriber-certainty"> Observed</label>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="form-label">Notification Limits</label>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <span class="text-xs text-gray-500 dark:text-gray-400">Max per hour</span>
                                <input type="number" id="subscriber_max_hour" class="form-input" min="1" value="10">
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 dark:text-gray-400">Max per day</span>
                                <input type="number" id="subscriber_max_day" class="form-input" min="1" value="50">
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="form-label">Quiet Hours</label>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <span class="text-xs text-gray-500 dark:text-gray-400">Start</span>
                                <input type="time" id="subscriber_quiet_start" class="form-input">
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 dark:text-gray-400">End</span>
                                <input type="time" id="subscriber_quiet_end" class="form-input">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="subscriber_immediate" class="form-checkbox">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Immediate Delivery</label>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Send alerts as soon as they are received</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="subscriber_batch" class="form-checkbox">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Batch Delivery</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="subscriber_batch_interval" class="form-input" value="15" min="5">
                                <span class="text-xs text-gray-500 dark:text-gray-400">minutes</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="form-label">Timezone</label>
                    <input type="text" id="subscriber_timezone" class="form-input" placeholder="UTC">
                </div>
                
                <div class="flex justify-end gap-3 pt-2 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" class="btn-secondary" onclick="closeSubscriberModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Subscriber</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="template-modal" class="fixed inset-0 bg-gray-700 bg-opacity-60 hidden z-50 items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h3 id="template-modal-title" class="text-lg font-semibold text-gray-900 dark:text-white">
                    Add Template
                </h3>
                <button type="button" onclick="closeTemplateModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="template-form" class="px-6 py-6 space-y-6" onsubmit="saveTemplate(event)">
                <input type="hidden" id="template_id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Template Name</label>
                        <input type="text" id="template_name" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">Template Type</label>
                        <select id="template_type" class="form-input">
                            <option value="email">Email</option>
                            <option value="webhook">Webhook</option>
                            <option value="push">Push</option>
                            <option value="sms">SMS</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Format</label>
                        <select id="template_format" class="form-input">
                            <option value="text">Plain Text</option>
                            <option value="html">HTML</option>
                            <option value="markdown">Markdown</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Description</label>
                        <input type="text" id="template_description" class="form-input" placeholder="Short description">
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="template_enabled" class="form-checkbox">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Enabled</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Disabled templates are kept for reference but not used for notifications.</p>
                    </div>
                </div>
                
                <div>
                    <label class="form-label">Subject Template</label>
                    <input type="text" id="template_subject" class="form-input" placeholder="Weather Alert: {{event}}">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use {{variable}} placeholders such as {{event}}, {{area_desc}}, {{severity}}.</p>
                </div>
                
                <div>
                    <label class="form-label">Body Template</label>
                    <textarea id="template_body" class="form-input font-mono text-sm" rows="12" placeholder="Template body goes here"></textarea>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">HTML and Markdown formats support rich content. JSON format should be valid JSON.</p>
                </div>
                
                <div class="bg-blue-50 dark:bg-blue-900/30 rounded-md p-4 text-sm text-blue-800 dark:text-blue-100">
                    <p class="font-medium">Available Variables</p>
                    <p class="mt-1 text-blue-700 dark:text-blue-200">Use {{event}}, {{area_desc}}, {{severity}}, {{urgency}}, {{certainty}}, {{effective}}, {{expires}}, {{description}}, {{instruction}}, and more. Unsupported variables will be left empty.</p>
                </div>
                
                <div class="flex justify-end gap-3 pt-2 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" class="btn-secondary" onclick="closeTemplateModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Template</button>
                </div>
            </form>
        </div>
    </div>

    <!-- County Search Modal (outside form to prevent submission) -->
    <div id="county-search-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Search Counties</h3>
                <div class="mt-4">
                    <input type="text" id="county-search-input" placeholder="Search by county name or state..." 
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100"
                           oninput="filterCountySearch()">
                </div>
            </div>
            <div class="overflow-y-auto p-6 flex-1">
                <div id="county-search-results" class="space-y-2">
                    <!-- Search results will be populated here -->
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                <button type="button" onclick="hideCountySearch()" class="btn-secondary">
                    Close
                </button>
            </div>
        </div>
    </div>

</div>

<!-- Sticky save bar (always visible at bottom) -->
<div id="config-sticky-bar" class="fixed bottom-0 right-0 z-40 flex items-center justify-between gap-4 px-4 py-3 bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] sticky-bar-offset">
    <div id="config-unsaved-hint" class="hidden text-sm text-amber-600 dark:text-amber-400 font-medium">You have unsaved changes.</div>
    <div class="flex-1 md:flex-none"></div>
    <div class="flex flex-wrap items-center gap-2">
        <button type="button" onclick="resetConfig()" class="btn-secondary text-sm">
            <svg class="w-4 h-4 mr-1.5 inline" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 01-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
            Reset
        </button>
        <button type="button" onclick="backupConfig()" class="btn-secondary text-sm">
            <svg class="w-4 h-4 mr-1.5 inline" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"></path></svg>
            Backup
        </button>
        <button type="button" onclick="previewConfig()" class="btn-secondary text-sm">
            <svg class="w-4 h-4 mr-1.5 inline" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
            Preview
        </button>
        <button type="button" id="config-save-btn" onclick="saveConfig()" class="btn-primary text-sm">
            <svg class="w-4 h-4 mr-1.5 inline" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
            Save Configuration
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentConfig = {};
    let currentTab = 'core';
    let allCounties = []; // Will hold all county data
    const SUBSCRIBER_DEFAULT_SEVERITIES = ['Minor', 'Moderate', 'Severe', 'Extreme'];
    const SUBSCRIBER_DEFAULT_URGENCIES = ['Future', 'Expected', 'Immediate'];
    const SUBSCRIBER_DEFAULT_CERTAINTIES = ['Possible', 'Likely', 'Observed'];
    const SUBSCRIBER_DEFAULT_METHODS = ['email'];
    const TEMPLATE_TYPES = [
        { value: 'email', label: 'Email (HTML/Text)' },
        { value: 'webhook', label: 'Webhook (JSON payload)' },
        { value: 'push', label: 'Push Notification' },
        { value: 'sms', label: 'SMS/Text Message' }
    ];
    const TEMPLATE_FORMATS = [
        { value: 'text', label: 'Plain Text' },
        { value: 'html', label: 'HTML' },
        { value: 'markdown', label: 'Markdown' },
        { value: 'json', label: 'JSON' }
    ];
    let subscribersCache = [];
    let templatesCache = [];
    let editingSubscriberId = null;
    let editingTemplateId = null;
    let configFormDirty = false;
    let configFormLoading = false;

    // Unsaved changes: track form edits
    function markConfigDirty() {
        if (configFormLoading) return;
        configFormDirty = true;
        const hint = document.getElementById('config-unsaved-hint');
        if (hint) hint.classList.remove('hidden');
    }
    function clearConfigDirty() {
        configFormDirty = false;
        const hint = document.getElementById('config-unsaved-hint');
        if (hint) hint.classList.add('hidden');
    }
    function setupConfigDirtyListeners() {
        const form = document.getElementById('config-form');
        if (!form) return;
        form.addEventListener('input', markConfigDirty);
        form.addEventListener('change', markConfigDirty);
        window.addEventListener('beforeunload', function(e) {
            if (configFormDirty) { e.preventDefault(); }
        });
    }

    // Tab management
    function updateTTSEngineFields() {
        const engine = document.getElementById('tts_engine').value;
        const gttsFields = document.querySelectorAll('.tts-gtts-field');
        const piperFields = document.querySelectorAll('.tts-piper-field');
        
        if (engine === 'gtts') {
            // Show gTTS fields, hide Piper fields
            gttsFields.forEach(field => {
                field.style.display = 'block';
            });
            piperFields.forEach(field => {
                field.style.display = 'none';
            });
        } else if (engine === 'piper') {
            // Show Piper fields, hide gTTS fields
            gttsFields.forEach(field => {
                field.style.display = 'none';
            });
            piperFields.forEach(field => {
                field.style.display = 'block';
            });
        }
    }
    
    var TAB_TO_GROUP = { core: 'general', nws: 'general', counties: 'general', asterisk: 'asterisk', audio: 'asterisk', alerts: 'alerts', filtering: 'alerts', scripts: 'alerts', notifications: 'notifications', subscribers: 'notifications', templates: 'notifications', logging: 'system', database: 'system', monitoring: 'system' };
    var GROUP_FIRST = { general: 'core', asterisk: 'asterisk', alerts: 'alerts', notifications: 'notifications', system: 'logging' };
    var TAB_LABELS = { core: 'Core Settings', nws: 'NWS API', counties: 'Counties', asterisk: 'Asterisk', audio: 'Audio & TTS', alerts: 'Alert Behavior', filtering: 'Filtering', scripts: 'Scripts', logging: 'Logging', database: 'Database', monitoring: 'Monitoring', notifications: 'Notifications', subscribers: 'Subscribers', templates: 'Templates' };

    function showConfigGroup(group) {
        if (configFormDirty && !confirm('You have unsaved changes. Switch section anyway?')) return;
        var go = TAB_TO_GROUP[currentTab] === group ? currentTab : GROUP_FIRST[group];
        if (go) _showTab(go);
    }
    function showTab(tabName) {
        if (configFormDirty && !confirm('You have unsaved changes. Switch section anyway?')) return;
        _showTab(tabName);
    }
    function _showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.add('hidden'); });
        document.querySelectorAll('.tab-button').forEach(function(btn) {
            btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
            btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            btn.setAttribute('aria-selected', 'false');
        });
        var content = document.getElementById('tab-content-' + tabName);
        if (content) content.classList.remove('hidden');
        var activeBtn = document.getElementById('tab-' + tabName);
        if (activeBtn) {
            activeBtn.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            activeBtn.setAttribute('aria-selected', 'true');
        }
        var sel = document.getElementById('config-section-select');
        if (sel) sel.value = tabName;
        currentTab = tabName;
        var group = TAB_TO_GROUP[tabName];
        if (group) {
            document.querySelectorAll('.config-primary-tab').forEach(function(b) {
                b.classList.remove('active', 'border-blue-500', 'text-blue-600');
                b.classList.add('border-transparent', 'text-gray-500');
                b.setAttribute('aria-selected', 'false');
            });
            var primary = document.getElementById('primary-' + group);
            if (primary) {
                primary.classList.add('active', 'border-blue-500', 'text-blue-600');
                primary.classList.remove('border-transparent', 'text-gray-500');
                primary.setAttribute('aria-selected', 'true');
            }
            document.querySelectorAll('.secondary-tabs').forEach(function(n) { n.classList.add('hidden'); });
            var sec = document.getElementById('secondary-' + group);
            if (sec) sec.classList.remove('hidden');
        }
        var bc = document.getElementById('config-breadcrumb-tab');
        if (bc) bc.textContent = TAB_LABELS[tabName] || tabName;
    }

    // Load configuration
    async function loadConfig() {
        try {
            configFormLoading = true;
            currentConfig = await apiCall('/api/config');
            window.currentConfig = currentConfig;  // Make available globally
            populateForm(currentConfig);
            clearConfigDirty();
            showNotification('Configuration loaded', 'success');
        } catch (error) {
            console.error('Failed to load configuration:', error);
            showNotification('Failed to load configuration', 'error');
        } finally {
            configFormLoading = false;
        }
    }

    // Populate form with configuration data
    function populateForm(config) {
        // Core settings
        document.getElementById('enabled').checked = config.enabled || false;
        document.getElementById('poll_interval').value = config.poll_interval || 60;
        document.getElementById('data_dir').value = config.data_dir || '';
        document.getElementById('config_file').value = config.config_file || '';

        // NWS API
        document.getElementById('nws_base_url').value = config.nws?.base_url || '';
        document.getElementById('nws_timeout').value = config.nws?.timeout || 30;
        document.getElementById('nws_user_agent').value = config.nws?.user_agent || '';

        // Counties
        populateCounties(config.counties || []);

        // Asterisk
        document.getElementById('asterisk_enabled').checked = config.asterisk?.enabled || false;
        document.getElementById('asterisk_audio_delay').value = config.asterisk?.audio_delay || 0;
        document.getElementById('asterisk_playback_mode').value = config.asterisk?.playback_mode || 'local';
        document.getElementById('asterisk_ami_host').value = config.asterisk?.ami_host || '127.0.0.1';
        document.getElementById('asterisk_ami_port').value = config.asterisk?.ami_port || 5038;
        document.getElementById('asterisk_ami_username').value = config.asterisk?.ami_username || '';
        document.getElementById('asterisk_ami_secret').value = config.asterisk?.ami_secret || '';
        populateNodes(config.asterisk?.nodes || []);

        // Courtesy tones
        document.getElementById('ct_enabled').checked = config.asterisk?.courtesy_tones?.enabled || false;
        document.getElementById('ct_tone_dir').value = config.asterisk?.courtesy_tones?.tone_dir || 'SOUNDS/TONES';
        populateCTAlerts(config.asterisk?.courtesy_tones?.ct_alerts || []);
        populateCTTones(config.asterisk?.courtesy_tones?.tones || {});

        // ID Change
        document.getElementById('id_change_enabled').checked = config.asterisk?.id_change?.enabled || false;
        document.getElementById('id_change_id_dir').value = config.asterisk?.id_change?.id_dir || 'SOUNDS/ID';
        document.getElementById('id_change_normal_id').value = config.asterisk?.id_change?.normal_id || 'NORMALID.ulaw';
        document.getElementById('id_change_wx_id').value = config.asterisk?.id_change?.wx_id || 'WXID.ulaw';
        document.getElementById('id_change_rpt_id').value = config.asterisk?.id_change?.rpt_id || 'RPTID.ulaw';
        populateIDAlerts(config.asterisk?.id_change?.id_alerts || []);

        // Audio & TTS
        document.getElementById('audio_sounds_path').value = config.audio?.sounds_path || '';
        document.getElementById('audio_alert_sound').value = config.audio?.alert_sound || '';
        document.getElementById('audio_all_clear_sound').value = config.audio?.all_clear_sound || '';
        document.getElementById('audio_separator_sound').value = config.audio?.separator_sound || '';
        document.getElementById('audio_temp_dir').value = config.audio?.temp_dir || '';
        
        document.getElementById('tts_engine').value = config.audio?.tts?.engine || 'gtts';
        document.getElementById('tts_language').value = config.audio?.tts?.language || 'en';
        document.getElementById('tts_tld').value = config.audio?.tts?.tld || 'com';
        document.getElementById('tts_slow').checked = config.audio?.tts?.slow || false;
        document.getElementById('tts_model_path').value = config.audio?.tts?.model_path || '';
        document.getElementById('tts_speed').value = config.audio?.tts?.speed || 1.0;
        document.getElementById('tts_output_format').value = config.audio?.tts?.output_format || 'ulaw';
        document.getElementById('tts_sample_rate').value = config.audio?.tts?.sample_rate || 8000;
        document.getElementById('tts_bit_rate').value = config.audio?.tts?.bit_rate || 128;
        
        // Update field visibility based on selected engine
        updateTTSEngineFields();

        // Alert behavior
        document.getElementById('alerts_say_alert').checked = config.alerts?.say_alert || false;
        document.getElementById('alerts_say_all_clear').checked = config.alerts?.say_all_clear || false;
        document.getElementById('alerts_tail_message').checked = config.alerts?.tail_message || false;
        document.getElementById('alerts_tail_message_path').value = config.alerts?.tail_message_path || '';
        document.getElementById('alerts_tail_message_suffix').value = config.alerts?.tail_message_suffix || '';
        document.getElementById('alerts_tail_message_counties').checked = config.alerts?.tail_message_counties || false;
        document.getElementById('alerts_with_county_names').checked = config.alerts?.with_county_names || false;
        document.getElementById('alerts_time_type').value = config.alerts?.time_type || 'onset';
        document.getElementById('alerts_say_alert_suffix').value = config.alerts?.say_alert_suffix || '';
        document.getElementById('alerts_say_all_clear_suffix').value = config.alerts?.say_all_clear_suffix || '';
        document.getElementById('alerts_say_alerts_changed').checked = config.alerts?.say_alerts_changed !== false; // Default true
        document.getElementById('alerts_say_alert_all').checked = config.alerts?.say_alert_all || false;
        document.getElementById('alerts_with_multiples').checked = config.alerts?.with_multiples || false;

        // Filtering
        document.getElementById('filtering_max_alerts').value = config.filtering?.max_alerts || 99;
        populateBlockedEvents(config.filtering?.blocked_events || []);
        populateSayAlertBlocked(config.filtering?.say_alert_blocked || []);
        populateTailMessageBlocked(config.filtering?.tail_message_blocked || []);

        // Scripts
        document.getElementById('scripts_enabled').checked = config.scripts?.enabled || false;
        document.getElementById('scripts_default_timeout').value = config.scripts?.default_timeout || 30;
        populateAlertScripts(config.scripts?.alert_scripts || {});
        populateAllClearScript(config.scripts?.all_clear_script);

        // Logging
        document.getElementById('logging_level').value = config.logging?.level || 'INFO';
        document.getElementById('logging_format').value = config.logging?.format || 'json';
        document.getElementById('logging_file').value = config.logging?.file || '';

        // Database
        document.getElementById('database_enabled').checked = config.database?.enabled || false;
        document.getElementById('database_url').value = config.database?.url || '';
        document.getElementById('database_cleanup_interval').value = config.database?.cleanup_interval_hours || 24;
        document.getElementById('database_retention_days').value = config.database?.retention_days || 30;
        document.getElementById('database_backup_enabled').checked = config.database?.backup_enabled || false;
        document.getElementById('database_backup_interval').value = config.database?.backup_interval_hours || 24;

        // Monitoring
        document.getElementById('monitoring_enabled').checked = config.monitoring?.enabled || false;
        document.getElementById('monitoring_health_check_interval').value = config.monitoring?.health_check_interval || 60;
        document.getElementById('monitoring_http_enabled').checked = config.monitoring?.http_server?.enabled || false;
        document.getElementById('monitoring_http_host').value = config.monitoring?.http_server?.host || '0.0.0.0';
        document.getElementById('monitoring_http_port').value = config.monitoring?.http_server?.port || 8080;
        document.getElementById('monitoring_metrics_enabled').checked = config.monitoring?.metrics?.enabled || false;
        document.getElementById('monitoring_metrics_retention').value = config.monitoring?.metrics?.retention_days || 7;
        
        // Authentication
        document.getElementById('monitoring_auth_enabled').checked = config.monitoring?.http_server?.auth?.enabled || false;
        document.getElementById('monitoring_auth_session_timeout').value = config.monitoring?.http_server?.auth?.session_timeout_hours || 24;
        document.getElementById('monitoring_auth_username').value = config.monitoring?.http_server?.auth?.username || 'admin';
        // Don't populate password field for security reasons - it will remain blank

        // PushOver
        document.getElementById('pushover_enabled').checked = config.pushover?.enabled || false;
        document.getElementById('pushover_priority').value = config.pushover?.priority ?? 0;
        document.getElementById('pushover_api_token').value = config.pushover?.api_token || '';
        document.getElementById('pushover_user_key').value = config.pushover?.user_key || '';
        document.getElementById('pushover_sound').value = config.pushover?.sound || '';
        document.getElementById('pushover_timeout').value = config.pushover?.timeout_seconds || 30;

        // DEV / Test Injection
        document.getElementById('dev_inject_enabled').checked = config.dev?.inject_enabled || false;
        document.getElementById('dev_cleanslate').checked = config.dev?.cleanslate || false;

        // Notifications - populate if available
        populateNotifications(config.notifications || {});
        
        // Subscribers and Templates are loaded separately when their tabs are shown
    }

    // Notifications management
    function populateNotifications(notifications) {
        // Email settings
        if (notifications.email) {
            const emailInputs = document.querySelectorAll('[name^="notifications.email."]');
            emailInputs.forEach(input => {
                const fieldName = input.name.split('.').pop();
                if (notifications.email[fieldName] !== undefined) {
                    if (input.type === 'checkbox') {
                        input.checked = notifications.email[fieldName];
                    } else {
                        input.value = notifications.email[fieldName];
                    }
                }
            });
        }
        
        // Webhook settings
        if (notifications.webhook) {
            const webhookInputs = document.querySelectorAll('[name^="notifications.webhook."]');
            webhookInputs.forEach(input => {
                const fieldName = input.name.split('.').pop();
                if (notifications.webhook[fieldName] !== undefined) {
                    input.value = notifications.webhook[fieldName];
                }
            });
        }
        
        // Push settings
        if (notifications.push) {
            const pushInputs = document.querySelectorAll('[name^="notifications.push."]');
            pushInputs.forEach(input => {
                const fieldName = input.name.split('.').pop();
                if (notifications.push[fieldName] !== undefined) {
                    if (input.type === 'password') {
                        input.value = ''; // Don't populate passwords for security
                    } else {
                        input.value = notifications.push[fieldName];
                    }
                }
            });
        }
        
        // Delivery settings
        if (notifications.delivery) {
            const deliveryInputs = document.querySelectorAll('[name^="notifications.delivery."]');
            deliveryInputs.forEach(input => {
                const fieldName = input.name.split('.').pop();
                if (notifications.delivery[fieldName] !== undefined) {
                    input.value = notifications.delivery[fieldName];
                }
            });
        }
    }

    // County management
    function loadCountyData() {
        // Load county data from JSON file
        const basePath = (typeof getBasePath === 'function') ? getBasePath() : ('{{ base_path|default("") }}' || '');
        fetch(`${basePath}/static/county_codes.json`)
            .then(response => response.json())
            .then(data => {
                allCounties = data;
                console.log(`Loaded ${allCounties.length} counties`);
            })
            .catch(error => {
                console.error('Error loading county data:', error);
            });
    }
    
    function showCountySearch() {
        const modal = document.getElementById('county-search-modal');
        const searchInput = document.getElementById('county-search-input');
        
        // Load county data if not already loaded
        if (allCounties.length === 0) {
            loadCountyData();
            // Wait a moment for data to load, then show modal
            setTimeout(() => {
                modal.classList.remove('hidden');
                searchInput.focus();
            }, 100);
        } else {
            modal.classList.remove('hidden');
            searchInput.focus();
        }
    }
    
    function hideCountySearch() {
        const modal = document.getElementById('county-search-modal');
        modal.classList.add('hidden');
    }
    
    function filterCountySearch() {
        const searchTerm = document.getElementById('county-search-input').value.toLowerCase();
        const resultsContainer = document.getElementById('county-search-results');
        resultsContainer.innerHTML = '';
        
        if (!searchTerm.trim()) {
            // Show all counties grouped by state when search is empty
            showAllCountiesGrouped();
            return;
        }
        
        // Filter counties by search term
        const filtered = allCounties.filter(county => {
            return county.search_terms.includes(searchTerm) || 
                   county.state_code.toLowerCase().includes(searchTerm) ||
                   county.state.toLowerCase().includes(searchTerm);
        });
        
        if (filtered.length === 0) {
            resultsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">No counties found.</p>';
            return;
        }
        
        // Display filtered results (limit to first 200 for performance)
        const displayCount = Math.min(filtered.length, 200);
        for (let i = 0; i < displayCount; i++) {
            const county = filtered[i];
            const result = document.createElement('div');
            result.className = 'p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer border border-gray-200 dark:border-gray-600';
            result.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">${county.name}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">${county.state}, ${county.code}</div>
                    </div>
                    <button type="button" onclick="addCountyFromSearch('${county.code}', '${county.name.replace(/'/g, "\\'")}')" class="btn-primary text-sm px-3 py-1">
                        Add
                    </button>
                </div>
            `;
            resultsContainer.appendChild(result);
        }
        
        if (filtered.length > 200) {
            const moreMsg = document.createElement('p');
            moreMsg.className = 'text-center text-sm text-gray-500 dark:text-gray-400';
            moreMsg.textContent = `${filtered.length - 200} more results. Please refine your search.`;
            resultsContainer.appendChild(moreMsg);
        }
    }
    
    function showAllCountiesGrouped() {
        const resultsContainer = document.getElementById('county-search-results');
        resultsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">Type to search counties...</p>';
    }
    
    function addCountyFromSearch(code, name) {
        // Add the selected county to the list
        const container = document.getElementById('counties-container');
        const currentCounties = container.children.length;
        addCountyRow(code, name, true, currentCounties, '');
        
        // Scroll to the newly added county
        const newRow = container.lastElementChild;
        if (newRow) {
            newRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            // Highlight the newly added row briefly
            newRow.style.transition = 'background-color 0.3s';
            newRow.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
            setTimeout(() => {
                newRow.style.backgroundColor = '';
            }, 2000);
        }
        
        // Show notification
        showNotification(`Added county: ${name}`, 'success');
        
        // Close the modal
        hideCountySearch();
        
        // Clear search
        document.getElementById('county-search-input').value = '';
    }
    
    function populateCounties(counties) {
        const container = document.getElementById('counties-container');
        container.innerHTML = '';
        
        counties.forEach((county, index) => {
            addCountyRow(county.code, county.name, county.enabled, index, county.audio_file || '');
        });
    }

    function addCounty() {
        const container = document.getElementById('counties-container');
        const currentCounties = container.children.length;
        addCountyRow('', '', true, currentCounties, '');
    }

    function addCountyRow(code, name, enabled, index, audio_file) {
        const container = document.getElementById('counties-container');
        const row = document.createElement('div');
        row.className = 'grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg';
        row.innerHTML = `
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">County Code</label>
                <input type="text" name="counties[${index}].code" value="${code}" 
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">County Name</label>
                <input type="text" name="counties[${index}].name" value="${name}" 
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Audio File (optional)</label>
                <div class="flex gap-2">
                    <input type="text" name="counties[${index}].audio_file" id="county_audio_${index}" value="${audio_file || ''}" 
                           placeholder="CountyName.ulaw"
                           class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                    <button type="button" onclick="generateCountyAudio('${code}', '${name}', ${index}, event)" 
                            class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                            title="Generate audio file from county name">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                        </svg>
                    </button>
                </div>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                    Audio file for county name (e.g., "Brazoria_County.ulaw") - Click button to generate
                </p>
            </div>
            <div class="flex items-center">
                <input type="checkbox" name="counties[${index}].enabled" ${enabled ? 'checked' : ''} 
                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Enabled</label>
            </div>
            <div class="flex items-center">
                <button type="button" onclick="removeCountyRow(this)" class="btn-secondary text-sm">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    Remove
                </button>
            </div>
        `;
        container.appendChild(row);
    }

    function removeCountyRow(button) {
        button.closest('.grid').remove();
    }

    // Node management
    function populateNodes(nodes) {
        const container = document.getElementById('nodes-container');
        container.innerHTML = '';
        
        nodes.forEach((node, index) => {
            addNodeRow(node, index);
        });
    }

    function addNode() {
        const container = document.getElementById('nodes-container');
        const currentNodes = container.children.length;
        addNodeRow({number: '', counties: null}, currentNodes);
    }

    function addNodeRow(node, index) {
        const container = document.getElementById('nodes-container');
        const row = document.createElement('div');
        row.className = 'mb-4 p-3 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/50';
        
        // Handle both old format (int) and new format (object with number and counties)
        let nodeNumber = '';
        let nodeCounties = null;
        
        if (typeof node === 'number') {
            nodeNumber = node;
            nodeCounties = null;  // null means monitor all counties
        } else if (typeof node === 'object' && node !== null) {
            nodeNumber = node.number || '';
            nodeCounties = node.counties || null;
        }
        
        // Get available counties from config for the multi-select
        const availableCounties = window.currentConfig?.counties || [];
        const countiesOptions = availableCounties.map(c => {
            const isSelected = nodeCounties && Array.isArray(nodeCounties) && nodeCounties.includes(c.code);
            return `<option value="${esc(c.code)}" ${isSelected ? 'selected' : ''}>${esc(c.code)} - ${esc(c.name || c.code)}</option>`;
        }).join('');
        
        row.innerHTML = `
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Node Number</label>
                    <input type="number" name="asterisk.nodes[${index}].number" value="${nodeNumber}" min="1" max="999999" 
                           class="w-32 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                           placeholder="546050">
                </div>
                <div class="flex-grow">
                    <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">
                        Monitored Counties
                        <span class="text-gray-500 font-normal">(leave empty to monitor all)</span>
                    </label>
                    <select multiple name="asterisk.nodes[${index}].counties" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                            style="min-height: 80px;">
                        ${countiesOptions}
                    </select>
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                        Hold Ctrl/Cmd to select multiple. Leave empty to monitor all enabled counties.
                    </p>
                </div>
                <div class="flex-shrink-0 pt-6">
                    <button type="button" onclick="removeNodeRow(this)" class="btn-secondary text-sm">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(row);
    }

    function removeNodeRow(button) {
        button.closest('.mb-4').remove();
    }

    // Courtesy tone alerts management
    function populateCTAlerts(alerts) {
        const container = document.getElementById('ct-alerts-container');
        container.innerHTML = '';
        
        alerts.forEach((alert, index) => {
            addCTAlertRow(alert, index);
        });
    }

    function addCTAlert() {
        const container = document.getElementById('ct-alerts-container');
        const currentAlerts = container.children.length;
        addCTAlertRow('', currentAlerts);
    }

    function addCTAlertRow(alert, index) {
        const container = document.getElementById('ct-alerts-container');
        const row = document.createElement('div');
        row.className = 'flex items-center space-x-2 mb-2';
        row.innerHTML = `
            <input type="text" name="asterisk.courtesy_tones.ct_alerts[${index}]" value="${alert}" 
                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                   placeholder="e.g., Tornado Warning, *Warning">
            <button type="button" onclick="removeCTAlertRow(this)" class="btn-secondary text-sm">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        `;
        container.appendChild(row);
    }

    function removeCTAlertRow(button) {
        button.closest('.flex').remove();
    }

    // Courtesy tone mappings management
    function populateCTTones(tones) {
        const container = document.getElementById('ct-tones-container');
        container.innerHTML = '';
        
        if (tones && Object.keys(tones).length > 0) {
            Object.entries(tones).forEach(([ctKey, toneConfig]) => {
                addCTToneRow(ctKey, toneConfig.Normal || '', toneConfig.WX || '');
            });
        }
    }

    function addCTTone() {
        const container = document.getElementById('ct-tones-container');
        const ctKey = prompt('Enter CT key (e.g., ct1, ct2):');
        if (ctKey) {
            addCTToneRow(ctKey, '', '');
        }
    }

    function addCTToneRow(ctKey, normalTone, wxTone) {
        const container = document.getElementById('ct-tones-container');
        const row = document.createElement('div');
        row.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-4';
        row.innerHTML = `
            <div class="flex items-center justify-between mb-3">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">${ctKey}</label>
                <button type="button" onclick="removeCTToneRow(this)" class="btn-secondary text-sm">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Normal Mode Tone</label>
                    <input type="text" name="asterisk.courtesy_tones.tones.${ctKey}.Normal" value="${normalTone}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                           placeholder="e.g., Boop.ulaw">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">WX Mode Tone</label>
                    <input type="text" name="asterisk.courtesy_tones.tones.${ctKey}.WX" value="${wxTone}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                           placeholder="e.g., Stardust.ulaw">
                </div>
            </div>
        `;
        container.appendChild(row);
    }

    function removeCTToneRow(button) {
        button.closest('.border').remove();
    }

    // ID change alerts management
    function populateIDAlerts(alerts) {
        const container = document.getElementById('id-alerts-container');
        container.innerHTML = '';
        
        alerts.forEach((alert, index) => {
            addIDAlertRow(alert, index);
        });
    }

    function addIDAlert() {
        const container = document.getElementById('id-alerts-container');
        const currentAlerts = container.children.length;
        addIDAlertRow('', currentAlerts);
    }

    function addIDAlertRow(alert, index) {
        const container = document.getElementById('id-alerts-container');
        const row = document.createElement('div');
        row.className = 'flex items-center space-x-2 mb-2';
        row.innerHTML = `
            <input type="text" name="asterisk.id_change.id_alerts[${index}]" value="${alert}" 
                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100"
                   placeholder="e.g., Tornado Warning, *Warning">
            <button type="button" onclick="removeIDAlertRow(this)" class="btn-secondary text-sm">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        `;
        container.appendChild(row);
    }

    function removeIDAlertRow(button) {
        button.closest('.flex').remove();
    }

    // Blocked events management
    function populateBlockedEvents(events) {
        const container = document.getElementById('blocked-events-container');
        container.innerHTML = '';
        
        events.forEach((event, index) => {
            addBlockedEventRow(event, index);
        });
    }

    function addBlockedEvent() {
        const container = document.getElementById('blocked-events-container');
        const currentEvents = container.children.length;
        addBlockedEventRow('', currentEvents);
    }

    function addBlockedEventRow(event, index) {
        const container = document.getElementById('blocked-events-container');
        const row = document.createElement('div');
        row.className = 'flex items-center space-x-2 mb-2';
        row.innerHTML = `
            <input type="text" name="filtering.blocked_events[${index}]" value="${event}" 
                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
            <button type="button" onclick="removeBlockedEventRow(this)" class="btn-secondary text-sm">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        `;
        container.appendChild(row);
    }

    function removeBlockedEventRow(button) {
        button.closest('.flex').remove();
    }

    // Similar functions for say_alert_blocked and tail_message_blocked
    function populateSayAlertBlocked(events) {
        const container = document.getElementById('say-alert-blocked-container');
        container.innerHTML = '';
        
        events.forEach((event, index) => {
            addSayAlertBlockedRow(event, index);
        });
    }

    function addSayAlertBlocked() {
        const container = document.getElementById('say-alert-blocked-container');
        const currentEvents = container.children.length;
        addSayAlertBlockedRow('', currentEvents);
    }

    function addSayAlertBlockedRow(event, index) {
        const container = document.getElementById('say-alert-blocked-container');
        const row = document.createElement('div');
        row.className = 'flex items-center space-x-2 mb-2';
        row.innerHTML = `
            <input type="text" name="filtering.say_alert_blocked[${index}]" value="${event}" 
                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
            <button type="button" onclick="removeSayAlertBlockedRow(this)" class="btn-secondary text-sm">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        `;
        container.appendChild(row);
    }

    function removeSayAlertBlockedRow(button) {
        button.closest('.flex').remove();
    }

    function populateTailMessageBlocked(events) {
        const container = document.getElementById('tail-message-blocked-container');
        container.innerHTML = '';
        
        events.forEach((event, index) => {
            addTailMessageBlockedRow(event, index);
        });
    }

    function addTailMessageBlocked() {
        const container = document.getElementById('tail-message-blocked-container');
        const currentEvents = container.children.length;
        addTailMessageBlockedRow('', currentEvents);
    }

    function addTailMessageBlockedRow(event, index) {
        const container = document.getElementById('tail-message-blocked-container');
        const row = document.createElement('div');
        row.className = 'flex items-center space-x-2 mb-2';
        row.innerHTML = `
            <input type="text" name="filtering.tail_message_blocked[${index}]" value="${event}" 
                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
            <button type="button" onclick="removeTailMessageBlockedRow(this)" class="btn-secondary text-sm">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        `;
        container.appendChild(row);
    }

    function removeTailMessageBlockedRow(button) {
        button.closest('.flex').remove();
    }

    // Script management
    function populateAlertScripts(scripts) {
        const container = document.getElementById('alert-scripts-container');
        container.innerHTML = '';
        
        Object.entries(scripts).forEach(([eventType, script], index) => {
            addAlertScriptRow(eventType, script, index);
        });
    }

    function addAlertScript() {
        const container = document.getElementById('alert-scripts-container');
        const currentScripts = container.children.length;
        addAlertScriptRow('', { command: '', args: [], timeout: 30, enabled: true }, currentScripts);
    }

    function addAlertScriptRow(eventType, script, index) {
        const container = document.getElementById('alert-scripts-container');
        const row = document.createElement('div');
        row.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-4';
        row.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Event Type (glob pattern)</label>
                    <input type="text" name="scripts.alert_scripts[${index}].event_type" value="${eventType}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Command</label>
                    <input type="text" name="scripts.alert_scripts[${index}].command" value="${script.command || ''}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Arguments (comma-separated)</label>
                    <input type="text" name="scripts.alert_scripts[${index}].args" value="${(script.args || []).join(', ')}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Timeout (seconds)</label>
                    <input type="number" name="scripts.alert_scripts[${index}].timeout" value="${script.timeout || 30}" min="5" max="300" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" name="scripts.alert_scripts[${index}].enabled" ${script.enabled ? 'checked' : ''} 
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Enabled</label>
                </div>
                <div class="flex items-center">
                    <button type="button" onclick="removeAlertScriptRow(this)" class="btn-secondary text-sm">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Remove
                    </button>
                </div>
            </div>
        `;
        container.appendChild(row);
    }

    function removeAlertScriptRow(button) {
        button.closest('.border').remove();
    }

    function populateAllClearScript(script) {
        const container = document.getElementById('all-clear-script-container');
        container.innerHTML = '';
        
        if (script) {
            addAllClearScriptRow(script, 0);
        }
    }

    function addAllClearScript() {
        addAllClearScriptRow({ command: '', args: [], timeout: 30, enabled: true }, 0);
    }

    function addAllClearScriptRow(script, index) {
        const container = document.getElementById('all-clear-script-container');
        const row = document.createElement('div');
        row.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4';
        row.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Command</label>
                    <input type="text" name="scripts.all_clear_script.command" value="${script.command || ''}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Arguments (comma-separated)</label>
                    <input type="text" name="scripts.all_clear_script.args" value="${(script.args || []).join(', ')}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Timeout (seconds)</label>
                    <input type="number" name="scripts.all_clear_script.timeout" value="${script.timeout || 30}" min="5" max="300" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" name="scripts.all_clear_script.enabled" ${script.enabled ? 'checked' : ''} 
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Enabled</label>
                </div>
            </div>
        `;
        container.appendChild(row);
    }

    // Form actions
    async function saveConfig() {
        const saveBtn = document.getElementById('config-save-btn');
        const saveOrig = saveBtn ? saveBtn.innerHTML : '';
        try {
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1.5"></span> Saving…';
            }
            const formData = new FormData(document.getElementById('config-form'));
            const config = {};
            
            // First pass: collect multi-select values (like counties)
            const multiSelectValues = {};
            for (const [key, value] of formData.entries()) {
                if (key.includes('.counties')) {
                    if (!multiSelectValues[key]) {
                        multiSelectValues[key] = [];
                    }
                    multiSelectValues[key].push(value);
                }
            }
            
            // Convert form data to nested object
            for (const [key, value] of formData.entries()) {
                // Skip multi-select fields on first encounter - we'll handle them after
                if (key.includes('.counties') && multiSelectValues[key] && multiSelectValues[key].indexOf(value) !== multiSelectValues[key].length - 1) {
                    continue;
                }
                // Handle array notation like "asterisk.nodes[0]" or "counties[0].code"
                if (key.includes('[') && key.includes(']')) {
                    const arrayMatch = key.match(/^(.+)\[(\d+)\](.*)$/);
                    if (arrayMatch) {
                        const [, arrayPath, index, remainingPath] = arrayMatch;
                        const keys = arrayPath.split('.');
                        let current = config;
                        
                        // Navigate to the parent object
                        for (let i = 0; i < keys.length - 1; i++) {
                            if (!current[keys[i]]) {
                                current[keys[i]] = {};
                            }
                            current = current[keys[i]];
                        }
                        
                        // Initialize array if it doesn't exist
                        const arrayKey = keys[keys.length - 1];
                        if (!current[arrayKey]) {
                            current[arrayKey] = [];
                        }
                        
                        const arrayIndex = parseInt(index);
                        
                        // Handle nested object in array (e.g., "counties[0].code")
                        if (remainingPath) {
                            const nestedKeys = remainingPath.substring(1).split('.'); // Remove leading dot
                            
                            // Initialize object in array if it doesn't exist
                            if (!current[arrayKey][arrayIndex]) {
                                current[arrayKey][arrayIndex] = {};
                            }
                            
                            let nestedCurrent = current[arrayKey][arrayIndex];
                            
                            // Navigate to nested property
                            for (let i = 0; i < nestedKeys.length - 1; i++) {
                                if (!nestedCurrent[nestedKeys[i]]) {
                                    nestedCurrent[nestedKeys[i]] = {};
                                }
                                nestedCurrent = nestedCurrent[nestedKeys[i]];
                            }
                            
                            // Set nested value
                            const finalKey = nestedKeys[nestedKeys.length - 1];
                            if (finalKey === 'counties' && multiSelectValues[key]) {
                                // Handle multi-select counties field
                                const selectedCounties = multiSelectValues[key];
                                nestedCurrent[finalKey] = selectedCounties.length > 0 ? selectedCounties : null;
                            } else if (value === 'on') {
                                nestedCurrent[finalKey] = true;
                            } else if (value === 'off') {
                                nestedCurrent[finalKey] = false;
                            } else if (!isNaN(value) && value !== '') {
                                nestedCurrent[finalKey] = Number(value);
                            } else if (finalKey === 'args') {
                                // Handle args fields - convert comma-separated string to array
                                nestedCurrent[finalKey] = value ? value.split(',').map(s => s.trim()).filter(s => s) : [];
                            } else {
                                nestedCurrent[finalKey] = value;
                            }
                        } else {
                            // Handle simple array value (e.g., "asterisk.nodes[0]")
                            if (value === 'on') {
                                current[arrayKey][arrayIndex] = true;
                            } else if (value === 'off') {
                                current[arrayKey][arrayIndex] = false;
                            } else if (!isNaN(value) && value !== '') {
                                current[arrayKey][arrayIndex] = Number(value);
                            } else {
                                current[arrayKey][arrayIndex] = value;
                            }
                        }
                        continue;
                    }
                }
                
                // Handle regular dot notation
                const keys = key.split('.');
                let current = config;
                
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!current[keys[i]]) {
                        current[keys[i]] = {};
                    }
                    current = current[keys[i]];
                }
                
                if (value === 'on') {
                    current[keys[keys.length - 1]] = true;
                } else if (value === 'off') {
                    current[keys[keys.length - 1]] = false;
                } else if (!isNaN(value) && value !== '') {
                    current[keys[keys.length - 1]] = Number(value);
                } else if (keys[keys.length - 1] === 'args') {
                    // Handle args fields - convert comma-separated string to array
                    current[keys[keys.length - 1]] = value ? value.split(',').map(s => s.trim()).filter(s => s) : [];
                } else {
                    current[keys[keys.length - 1]] = value;
                }
            }
            
            // Convert scripts.alert_scripts from array to dict
            if (config.scripts && config.scripts.alert_scripts && Array.isArray(config.scripts.alert_scripts)) {
                const alertScriptsDict = {};
                config.scripts.alert_scripts.forEach(script => {
                    if (script.event_type) {
                        alertScriptsDict[script.event_type] = {
                            command: script.command,
                            args: script.args || [],
                            timeout: script.timeout || 30,
                            enabled: script.enabled || false
                        };
                    }
                });
                config.scripts.alert_scripts = alertScriptsDict;
            }
            
            // Auto-generate inject_alerts if injection is enabled (backend will handle this)
            if (config.dev) {
                if (!config.dev.inject_alerts) config.dev.inject_alerts = [];
            }

            // Client-side validation
            const poll = parseInt(config.poll_interval, 10);
            if (isNaN(poll) || poll < 10 || poll > 3600) {
                showNotification('Poll interval must be between 10 and 3600 seconds.', 'warning');
                if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveOrig; }
                return;
            }
            if (config.nws) {
                const t = parseInt(config.nws.timeout, 10);
                if (!isNaN(t) && (t < 5 || t > 300)) {
                    showNotification('NWS timeout must be between 5 and 300 seconds.', 'warning');
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveOrig; }
                    return;
                }
            }
            if (config.asterisk && config.asterisk.ami_port) {
                const p = parseInt(config.asterisk.ami_port, 10);
                if (!isNaN(p) && (p < 1 || p > 65535)) {
                    showNotification('AMI port must be between 1 and 65535.', 'warning');
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveOrig; }
                    return;
                }
            }
            
            await apiCall('/api/config', {
                method: 'POST',
                body: JSON.stringify(config)
            });
            clearConfigDirty();
            showNotification('Configuration saved successfully', 'success');
        } catch (error) {
            console.error('Failed to save configuration:', error);
            showNotification('Failed to save configuration', 'error');
        } finally {
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveOrig; }
        }
    }

    async function resetConfig() {
        if (confirm('Are you sure you want to reset the configuration to defaults? This action cannot be undone.')) {
            try {
                await apiCall('/api/config/reset', { method: 'POST' });
                await loadConfig();
                showNotification('Configuration reset to defaults', 'success');
            } catch (error) {
                console.error('Failed to reset configuration:', error);
                showNotification('Failed to reset configuration', 'error');
            }
        }
    }

    async function backupConfig() {
        try {
            await apiCall('/api/config/backup', { method: 'POST' });
            showNotification('Configuration backed up successfully', 'success');
        } catch (error) {
            console.error('Failed to backup configuration:', error);
            showNotification('Failed to backup configuration', 'error');
        }
    }

    function previewConfig() {
        const formData = new FormData(document.getElementById('config-form'));
        const config = {};
        
        // Convert form data to nested object (same logic as saveConfig)
        for (const [key, value] of formData.entries()) {
            const keys = key.split('.');
            let current = config;
            
            for (let i = 0; i < keys.length - 1; i++) {
                if (!current[keys[i]]) {
                    current[keys[i]] = {};
                }
                current = current[keys[i]];
            }
            
            if (value === 'on') {
                current[keys[keys.length - 1]] = true;
            } else if (value === 'off') {
                current[keys[keys.length - 1]] = false;
            } else if (!isNaN(value) && value !== '') {
                current[keys[keys.length - 1]] = Number(value);
            } else if (keys[keys.length - 1] === 'args') {
                // Handle args fields - convert comma-separated string to array
                current[keys[keys.length - 1]] = value ? value.split(',').map(s => s.trim()).filter(s => s) : [];
            } else {
                current[keys[keys.length - 1]] = value;
            }
        }
        
        // Open preview in new window
        const previewWindow = window.open('', '_blank', 'width=800,height=600');
        previewWindow.document.write(`
            <html>
                <head>
                    <title>Configuration Preview</title>
                    <style>
                        body { font-family: monospace; margin: 20px; background: #f5f5f5; }
                        pre { background: white; padding: 20px; border-radius: 5px; border: 1px solid #ddd; }
                    </style>
                </head>
                <body>
                    <h1>Configuration Preview</h1>
                    <pre>${JSON.stringify(config, null, 2)}</pre>
                </body>
            </html>
        `);
    }

    // Notification functions
    async function testEmailConnection() {
        try {
            const formData = new FormData(document.getElementById('config-form'));
            const emailConfig = {
                provider: formData.get('notifications.email.provider'),
                smtp_server: formData.get('notifications.email.smtp_server'),
                smtp_port: parseInt(formData.get('notifications.email.smtp_port')),
                username: formData.get('notifications.email.username'),
                password: formData.get('notifications.email.password'),
                use_tls: formData.get('notifications.email.use_tls') === 'on',
                use_ssl: formData.get('notifications.email.use_ssl') === 'on'
            };
            
            showNotification('Testing email connection...', 'info');
            const result = await apiCall('/api/notifications/test-email', {
                method: 'POST',
                body: JSON.stringify(emailConfig)
            });
            
            if (result.success) {
                showNotification('Email connection test successful!', 'success');
            } else {
                showNotification(`Email connection test failed: ${result.error}`, 'error');
            }
        } catch (error) {
            console.error('Email connection test failed:', error);
            showNotification('Email connection test failed', 'error');
        }
    }

    async function loadSubscribers() {
        try {
            const subscribers = await apiCall('/api/notifications/subscribers');
            subscribersCache = Array.isArray(subscribers) ? subscribers : [];
            const tableBody = document.getElementById('subscribers-table');
            tableBody.innerHTML = '';
            
            if (subscribersCache.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                        No subscribers configured yet. Click "Add Subscriber" to get started.
                    </td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            subscribersCache.forEach(subscriber => {
                tableBody.appendChild(buildSubscriberRow(subscriber));
            });
        } catch (error) {
            console.error('Failed to load subscribers:', error);
            const tableBody = document.getElementById('subscribers-table');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                        Unable to load subscribers: ${error.message || 'Unknown error'}
                    </td>
                </tr>
            `;
        }
    }

    function buildSubscriberRow(subscriber) {
                const row = document.createElement('tr');
        const methods = formatSubscriberMethods(subscriber.preferences?.enabled_methods);
        const counties = (subscriber.preferences?.counties || []).join(', ') || 'All';
        const status = (subscriber.status || 'inactive').toLowerCase();
        const badgeClasses = status === 'active'
            ? 'bg-green-100 text-green-800'
            : status === 'suspended'
                ? 'bg-yellow-100 text-yellow-800'
                : 'bg-red-100 text-red-800';
        
                row.innerHTML = `
                    <td data-label="Name" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${subscriber.name}<div class="text-xs text-gray-500 dark:text-gray-400">${subscriber.email}</div></td>
                    <td data-label="Status" class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badgeClasses}">${status}</span></td>
                    <td data-label="Methods" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${methods}</td>
                    <td data-label="Counties" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${counties}</td>
                    <td data-label="Actions" class="px-6 py-4 whitespace-nowrap text-sm font-medium"><button type="button" onclick="editSubscriber('${subscriber.subscriber_id}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button><button type="button" onclick="deleteSubscriber('${subscriber.subscriber_id}')" class="text-red-600 hover:text-red-900">Delete</button></td>
                `;
        return row;
    }
    
    function formatSubscriberMethods(methods) {
        if (!methods || methods.length === 0) {
            return 'None';
        }
        return methods.map(method => {
            const text = (method && method.value) ? method.value : method;
            return text.charAt(0).toUpperCase() + text.slice(1);
        }).join(', ');
    }

    function addSubscriber() {
        editingSubscriberId = null;
        openSubscriberModal();
    }

    function editSubscriber(subscriberId) {
        const subscriber = subscribersCache.find(sub => sub.subscriber_id === subscriberId);
        if (!subscriber) {
            showNotification('Subscriber not found', 'error');
            return;
        }
        editingSubscriberId = subscriberId;
        openSubscriberModal(subscriber);
    }
    
    async function deleteSubscriber(subscriberId) {
        if (!confirm('Are you sure you want to delete this subscriber?')) {
            return;
        }
        try {
            await apiCall(`/api/notifications/subscribers/${subscriberId}`, { method: 'DELETE' });
            showNotification('Subscriber deleted', 'success');
            loadSubscribers();
        } catch (error) {
            console.error('Failed to delete subscriber:', error);
            showNotification('Failed to delete subscriber', 'error');
        }
    }
    
    function openSubscriberModal(subscriber = null) {
        const modal = document.getElementById('subscriber-modal');
        document.getElementById('subscriber-form').reset();
        
        setCheckboxGroup('.subscriber-method', subscriber?.preferences?.enabled_methods, SUBSCRIBER_DEFAULT_METHODS);
        setCheckboxGroup('.subscriber-severity', subscriber?.preferences?.enabled_severities, SUBSCRIBER_DEFAULT_SEVERITIES);
        setCheckboxGroup('.subscriber-urgency', subscriber?.preferences?.enabled_urgencies, SUBSCRIBER_DEFAULT_URGENCIES);
        setCheckboxGroup('.subscriber-certainty', subscriber?.preferences?.enabled_certainties, SUBSCRIBER_DEFAULT_CERTAINTIES);
        
        if (subscriber) {
            populateSubscriberForm(subscriber);
            document.getElementById('subscriber-modal-title').textContent = 'Edit Subscriber';
        } else {
            document.getElementById('subscriber_id').value = '';
            document.getElementById('subscriber_status').value = 'active';
            document.getElementById('subscriber_immediate').checked = true;
            document.getElementById('subscriber_batch').checked = false;
            document.getElementById('subscriber_batch_interval').value = 15;
            document.getElementById('subscriber_timezone').value = 'UTC';
            document.getElementById('subscriber-modal-title').textContent = 'Add Subscriber';
        }
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeSubscriberModal() {
        const modal = document.getElementById('subscriber-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        editingSubscriberId = null;
    }
    
    function setCheckboxGroup(selector, values, fallbackValues = []) {
        let normalized = [];
        if (Array.isArray(values)) {
            normalized = values.map(v => v.toString().toLowerCase());
        } else if (values) {
            normalized = [values.toString().toLowerCase()];
        } else if (Array.isArray(fallbackValues)) {
            normalized = fallbackValues.map(v => v.toString().toLowerCase());
        }

        document.querySelectorAll(selector).forEach(cb => {
            cb.checked = normalized.includes(cb.value.toLowerCase());
        });
    }
    
    function populateSubscriberForm(subscriber) {
        document.getElementById('subscriber_id').value = subscriber.subscriber_id;
        document.getElementById('subscriber_name').value = subscriber.name || '';
        document.getElementById('subscriber_email').value = subscriber.email || '';
        document.getElementById('subscriber_status').value = subscriber.status || 'active';
        document.getElementById('subscriber_phone').value = subscriber.phone || '';
        document.getElementById('subscriber_webhook').value = subscriber.webhook_url || '';
        document.getElementById('subscriber_push_tokens').value = (subscriber.push_tokens || []).join('\n');
        
        const prefs = subscriber.preferences || {};
        document.getElementById('subscriber_counties').value = (prefs.counties || []).join(', ');
        document.getElementById('subscriber_states').value = (prefs.states || []).join(', ');
        document.getElementById('subscriber_custom_areas').value = (prefs.custom_areas || []).join(', ');
        document.getElementById('subscriber_enabled_events').value = (prefs.enabled_events || []).join(', ');
        document.getElementById('subscriber_blocked_events').value = (prefs.blocked_events || []).join(', ');
        document.getElementById('subscriber_immediate').checked = prefs.immediate_delivery !== false;
        document.getElementById('subscriber_batch').checked = !!prefs.batch_delivery;
        document.getElementById('subscriber_batch_interval').value = prefs.batch_interval_minutes || 15;
        document.getElementById('subscriber_quiet_start').value = prefs.quiet_hours_start || '';
        document.getElementById('subscriber_quiet_end').value = prefs.quiet_hours_end || '';
        document.getElementById('subscriber_timezone').value = prefs.timezone || 'UTC';
        document.getElementById('subscriber_max_hour').value = prefs.max_notifications_per_hour || 10;
        document.getElementById('subscriber_max_day').value = prefs.max_notifications_per_day || 50;
    }
    
    function getCheckedValues(selector) {
        return Array.from(document.querySelectorAll(selector))
            .filter(cb => cb.checked)
            .map(cb => cb.value);
    }
    
    function parseCSVList(value) {
        if (!value) return [];
        return value
            .split(/[,;\n]/)
            .map(item => item.trim())
            .filter(item => item.length > 0);
    }
    
    function collectSubscriberForm() {
        const payload = {
            subscriber_id: document.getElementById('subscriber_id').value || undefined,
            name: document.getElementById('subscriber_name').value.trim(),
            email: document.getElementById('subscriber_email').value.trim(),
            status: document.getElementById('subscriber_status').value,
            phone: document.getElementById('subscriber_phone').value.trim() || null,
            webhook_url: document.getElementById('subscriber_webhook').value.trim() || null,
            push_tokens: parseCSVList(document.getElementById('subscriber_push_tokens').value),
            preferences: {
                counties: parseCSVList(document.getElementById('subscriber_counties').value),
                states: parseCSVList(document.getElementById('subscriber_states').value),
                custom_areas: parseCSVList(document.getElementById('subscriber_custom_areas').value),
                enabled_events: parseCSVList(document.getElementById('subscriber_enabled_events').value),
                blocked_events: parseCSVList(document.getElementById('subscriber_blocked_events').value),
                enabled_methods: getCheckedValues('.subscriber-method'),
                enabled_severities: getCheckedValues('.subscriber-severity'),
                enabled_urgencies: getCheckedValues('.subscriber-urgency'),
                enabled_certainties: getCheckedValues('.subscriber-certainty'),
                immediate_delivery: document.getElementById('subscriber_immediate').checked,
                batch_delivery: document.getElementById('subscriber_batch').checked,
                batch_interval_minutes: Number(document.getElementById('subscriber_batch_interval').value) || 15,
                quiet_hours_start: document.getElementById('subscriber_quiet_start').value || null,
                quiet_hours_end: document.getElementById('subscriber_quiet_end').value || null,
                timezone: document.getElementById('subscriber_timezone').value || 'UTC',
                max_notifications_per_hour: Number(document.getElementById('subscriber_max_hour').value) || 10,
                max_notifications_per_day: Number(document.getElementById('subscriber_max_day').value) || 50
            }
        };
        return payload;
    }
    
    async function saveSubscriber(event) {
        event.preventDefault();
        const payload = collectSubscriberForm();
        const isEdit = Boolean(editingSubscriberId);
        const url = isEdit
            ? `/api/notifications/subscribers/${editingSubscriberId}`
            : '/api/notifications/subscribers';
        const method = isEdit ? 'PUT' : 'POST';
        
        try {
            await apiCall(url, {
                method,
                body: JSON.stringify(payload)
            });
            showNotification(isEdit ? 'Subscriber updated' : 'Subscriber added', 'success');
            closeSubscriberModal();
            loadSubscribers();
        } catch (error) {
            console.error('Failed to save subscriber:', error);
            showNotification('Failed to save subscriber', 'error');
        }
    }

    async function loadTemplates() {
        try {
            const templates = await apiCall('/api/notifications/templates');
            templatesCache = Array.isArray(templates) ? templates : [];
            renderTemplates();
        } catch (error) {
            console.error('Failed to load templates:', error);
            const templatesGrid = document.getElementById('templates-grid');
            templatesGrid.innerHTML = `
                <div class="col-span-full bg-gray-50 dark:bg-gray-700 rounded-lg p-8 text-center">
                    <div class="text-gray-500 dark:text-gray-400">
                        <svg class="mx-auto h-12 w-12 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                        </svg>
                        <p class="text-sm">Unable to load templates.</p>
                        <p class="text-xs mt-1">${error.message || 'Unknown error'}</p>
                    </div>
                </div>
            `;
        }
    }

    function renderTemplates() {
            const templatesGrid = document.getElementById('templates-grid');
            templatesGrid.innerHTML = '';
            
        if (!templatesCache.length) {
                const emptyCard = document.createElement('div');
                emptyCard.className = 'col-span-full bg-gray-50 dark:bg-gray-700 rounded-lg p-8 text-center';
                emptyCard.innerHTML = `
                    <div class="text-gray-500 dark:text-gray-400">
                        <svg class="mx-auto h-12 w-12 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-sm">No notification templates configured.</p>
                    <p class="text-xs mt-1">Click "Add Template" to create one.</p>
                    </div>
                `;
                templatesGrid.appendChild(emptyCard);
                return;
            }
            
        templatesCache.forEach(template => {
            templatesGrid.appendChild(buildTemplateCard(template));
        });
    }
    
    function buildTemplateCard(template) {
        const typeLabel = TEMPLATE_TYPES.find(t => t.value === template.template_type)?.label || template.template_type;
        const formatLabel = TEMPLATE_FORMATS.find(f => f.value === template.format)?.label || template.format;
        const statusBadge = template.enabled ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-600';
        const deleteClasses = template.is_default
            ? 'text-gray-400 cursor-not-allowed'
            : 'text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-200';
        const deleteDisabled = template.is_default ? 'disabled' : '';
        const card = document.createElement('div');
        card.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border border-gray-200 dark:border-gray-600';
        card.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                <div>
                                <h4 class="text-sm font-medium text-gray-900 dark:text-white">${template.name || 'Unnamed Template'}</h4>
                    <p class="text-xs text-gray-500 dark:text-gray-300">${template.description || 'No description provided'}</p>
                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                    ${typeLabel}
                                </span>
                            </div>
            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2">Format: ${formatLabel}${template.is_default ? ' • Default' : ''}</p>
                            <div class="flex justify-between items-center">
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusBadge}">
                                    ${template.enabled ? 'Enabled' : 'Disabled'}
                                </span>
                <div class="flex space-x-3 text-sm">
                    <button type="button" onclick="editTemplate('${template.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-200">Edit</button>
                    <button type="button" onclick="deleteTemplate('${template.id}', ${template.is_default})" class="${deleteClasses}" ${deleteDisabled}>Delete</button>
                                </div>
                            </div>
                        `;
        return card;
    }
    
    function addTemplate() {
        editingTemplateId = null;
        openTemplateModal();
    }
    
    async function editTemplate(templateId) {
        try {
            const template = await apiCall(`/api/notifications/templates/${templateId}`);
            editingTemplateId = templateId;
            openTemplateModal(template);
        } catch (error) {
            console.error(`Failed to load template ${templateId}:`, error);
            showNotification('Failed to load template', 'error');
        }
    }
    
    async function deleteTemplate(templateId, isDefault = false) {
        if (isDefault) {
            showNotification('Default templates cannot be deleted', 'warning');
            return;
        }
        
        if (!confirm('Are you sure you want to delete this template?')) {
            return;
        }
        
        try {
            await apiCall(`/api/notifications/templates/${templateId}`, { method: 'DELETE' });
            showNotification('Template deleted', 'success');
            loadTemplates();
        } catch (error) {
            console.error('Failed to delete template:', error);
            showNotification('Failed to delete template', 'error');
        }
    }

    function openTemplateModal(template = null) {
        const modal = document.getElementById('template-modal');
        const form = document.getElementById('template-form');
        form.reset();
        
        document.getElementById('template_enabled').checked = true;
        document.getElementById('template_type').value = 'email';
        document.getElementById('template_format').value = 'text';
        document.getElementById('template_subject').value = 'Weather Alert: {{event}}';
        document.getElementById('template_body').value = '';
        
        if (template) {
            populateTemplateForm(template);
            document.getElementById('template-modal-title').textContent = template.is_default ? 'View Default Template' : 'Edit Template';
            document.getElementById('template_type').disabled = template.is_default;
        } else {
            document.getElementById('template_id').value = '';
            document.getElementById('template-modal-title').textContent = 'Add Template';
            document.getElementById('template_type').disabled = false;
        }
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
    
    function closeTemplateModal() {
        const modal = document.getElementById('template-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        editingTemplateId = null;
        document.getElementById('template_type').disabled = false;
    }
    
    function populateTemplateForm(template) {
        document.getElementById('template_id').value = template.id || template.template_id || '';
        document.getElementById('template_name').value = template.name || '';
        document.getElementById('template_description').value = template.description || '';
        document.getElementById('template_type').value = template.template_type || 'email';
        document.getElementById('template_format').value = template.format || 'text';
        document.getElementById('template_enabled').checked = template.enabled !== false;
        document.getElementById('template_subject').value = template.subject_template || '';
        document.getElementById('template_body').value = template.body_template || '';
    }
    
    function collectTemplateForm() {
        return {
            template_id: document.getElementById('template_id').value || undefined,
            name: document.getElementById('template_name').value.trim(),
            description: document.getElementById('template_description').value.trim(),
            template_type: document.getElementById('template_type').value,
            format: document.getElementById('template_format').value,
            enabled: document.getElementById('template_enabled').checked,
            subject_template: document.getElementById('template_subject').value,
            body_template: document.getElementById('template_body').value
        };
    }
    
    async function saveTemplate(event) {
        event.preventDefault();
        const payload = collectTemplateForm();
        
        if (!payload.name || !payload.subject_template || !payload.body_template) {
            showNotification('Name, subject, and body are required', 'warning');
            return;
        }
        
        const isEdit = Boolean(editingTemplateId);
        const url = isEdit ? `/api/notifications/templates/${editingTemplateId}` : '/api/notifications/templates';
        const method = isEdit ? 'PUT' : 'POST';
        
        try {
            await apiCall(url, {
                method,
                body: JSON.stringify(payload)
            });
            showNotification(isEdit ? 'Template updated' : 'Template created', 'success');
            closeTemplateModal();
            loadTemplates();
        } catch (error) {
            console.error('Failed to save template:', error);
            showNotification('Failed to save template', 'error');
        }
    }

    // Database operations
    async function loadDatabaseStats() {
        try {
            const stats = await apiCall('/api/database/stats');
            updateDatabaseStatsDisplay(stats);
        } catch (error) {
            console.error('Failed to load database stats:', error);
            // Don't show error notification here, just log it
        }
    }

    function updateDatabaseStatsDisplay(stats) {
        if (stats.connected) {
            document.getElementById('db-total-alerts').textContent = stats.total_alerts || 0;
            
            // Format database size
            const sizeBytes = stats.database_size_bytes || 0;
            let sizeText = '-';
            if (sizeBytes > 0) {
                if (sizeBytes < 1024) {
                    sizeText = `${sizeBytes} B`;
                } else if (sizeBytes < 1024 * 1024) {
                    sizeText = `${(sizeBytes / 1024).toFixed(2)} KB`;
                } else {
                    sizeText = `${(sizeBytes / (1024 * 1024)).toFixed(2)} MB`;
                }
            }
            document.getElementById('db-size').textContent = sizeText;
            document.getElementById('db-metrics').textContent = stats.metrics_count || 0;
            document.getElementById('db-health-checks').textContent = stats.health_checks_count || 0;
        } else {
            document.getElementById('db-total-alerts').textContent = '-';
            document.getElementById('db-size').textContent = '-';
            document.getElementById('db-metrics').textContent = '-';
            document.getElementById('db-health-checks').textContent = '-';
        }
    }

    async function cleanupDatabase() {
        const days = prompt('Enter number of days of data to keep (default: 30):', '30');
        if (days === null) return; // User cancelled
        
        const daysNum = parseInt(days) || 30;
        if (confirm(`Are you sure you want to cleanup data older than ${daysNum} days? This action cannot be undone.`)) {
            try {
                const result = await apiCall('/api/database/cleanup', {
                    method: 'POST',
                    body: JSON.stringify({ days: daysNum })
                });
                
                if (result.success) {
                    const stats = result.stats || {};
                    const deleted = Object.values(stats).reduce((sum, val) => sum + (val || 0), 0);
                    showNotification(`Database cleanup completed: ${deleted} records deleted`, 'success');
                    loadDatabaseStats();
                } else {
                    showNotification('Database cleanup failed', 'error');
                }
            } catch (error) {
                console.error('Failed to cleanup database:', error);
                showNotification('Failed to cleanup database', 'error');
    }
        }
    }

    async function backupDatabase() {
        try {
            showNotification('Creating database backup...', 'info');
            const result = await apiCall('/api/database/backup', { method: 'POST' });
            
            if (result.success) {
                showNotification(`Database backup completed: ${result.backup_path}`, 'success');
            } else {
                showNotification('Database backup failed', 'error');
            }
        } catch (error) {
            console.error('Failed to backup database:', error);
            showNotification('Failed to backup database', 'error');
    }
    }

    async function optimizeDatabase() {
        if (confirm('Are you sure you want to optimize the database? This may take a few moments.')) {
            try {
                showNotification('Optimizing database...', 'info');
                const result = await apiCall('/api/database/optimize', { method: 'POST' });
                
                if (result.success) {
                    const stats = result.stats || {};
                    let message = 'Database optimization completed successfully';
                    if (stats.space_saved_bytes) {
                        const savedMB = (stats.space_saved_bytes / (1024 * 1024)).toFixed(2);
                        message += ` (saved ${savedMB} MB)`;
                    }
                    showNotification(message, 'success');
                    loadDatabaseStats();
                } else {
                    showNotification('Database optimization failed', 'error');
                }
            } catch (error) {
                console.error('Failed to optimize database:', error);
                showNotification('Failed to optimize database', 'error');
            }
        }
    }

    // Update showTab function to load data for new tabs
    const originalShowTab = showTab;
    showTab = function(tabName) {
        originalShowTab(tabName);
        
        // Load data for specific tabs
        if (tabName === 'subscribers') {
            loadSubscribers();
        } else if (tabName === 'templates') {
            loadTemplates();
        } else if (tabName === 'database') {
            loadDatabaseStats();
        }
    };

    // Generate county audio file
    async function generateCountyAudio(countyCode, countyName, index, event) {
        const button = event ? event.target.closest('button') : null;
        const audioInput = document.getElementById(`county_audio_${index}`);
        
        if (!audioInput) {
            alert('Could not find audio input field');
            return;
        }
        
        if (!button) {
            alert('Could not find button');
            return;
        }
        
        // Disable button and show loading state
        const originalHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
        
        try {
            const basePath = (typeof getBasePath === 'function') ? getBasePath() : ('{{ base_path|default("") }}' || '');
            const response = await fetch(`${basePath}/api/counties/${encodeURIComponent(countyCode)}/generate-audio`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // Update the audio file input field
                audioInput.value = data.filename;
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'mt-1 text-xs text-green-600 dark:text-green-400';
                successMsg.textContent = `✓ Generated: ${data.filename}`;
                audioInput.parentElement.parentElement.appendChild(successMsg);
                
                // Remove success message after 3 seconds
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
            } else {
                alert(`Failed to generate audio: ${data.error || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Error generating county audio:', error);
            alert(`Error generating audio: ${error.message}`);
        } finally {
            // Restore button state
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    // Toggle password visibility
    function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling;
        const icon = button.querySelector('svg');
        
        if (field.type === 'password') {
            field.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
            `;
        } else {
            field.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            `;
        }
    }

    var cf = document.getElementById('config-form');
    if (cf) cf.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') e.preventDefault();
    });

    function configTabKeydown(e) {
        var t = e.target;
        if (t.getAttribute('role') !== 'tab' || !['ArrowLeft','ArrowRight','Enter'].includes(e.key)) return;
        e.preventDefault();
        if (e.key === 'Enter') {
            if (t.onclick) t.onclick(); else t.click();
            return;
        }
        var list = t.closest('[role="tablist"]');
        if (!list) return;
        var tabs = [].slice.call(list.querySelectorAll('[role="tab"]'));
        var i = tabs.indexOf(t);
        if (i < 0) return;
        var next = e.key === 'ArrowLeft' ? (i - 1 + tabs.length) % tabs.length : (i + 1) % tabs.length;
        tabs[next].focus();
    }
    document.addEventListener('DOMContentLoaded', function() {
        setupConfigDirtyListeners();
        loadConfig();
        var primary = document.getElementById('config-primary-tabs');
        if (primary) primary.addEventListener('keydown', configTabKeydown);
        document.querySelectorAll('.secondary-tabs').forEach(function(n) {
            n.addEventListener('keydown', configTabKeydown);
        });
    });
</script>
{% endblock %}
